% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{book}
\usepackage{amsmath,amssymb}
\usepackage{lmodern}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
\usepackage{booktabs}
\usepackage{amsthm}
\makeatletter
\def\thm@space@setup{%
  \thm@preskip=8pt plus 2pt minus 4pt
  \thm@postskip=\thm@preskip
}
\makeatother
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\usepackage[]{natbib}
\bibliographystyle{plainnat}
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same} % disable monospaced font for URLs
\hypersetup{
  pdftitle={Metagenomics Workshop NCGR},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}

\title{Metagenomics Workshop NCGR}
\author{}
\date{\vspace{-2.5em}}

\begin{document}
\maketitle

{
\setcounter{tocdepth}{1}
\tableofcontents
}
\hypertarget{community-profiling-and-metagenomics}{%
\chapter{Community Profiling and Metagenomics}\label{community-profiling-and-metagenomics}}

\hypertarget{microbes-were-the-first-life-forms-on-this-planet}{%
\section{Microbes were the first life forms on this planet}\label{microbes-were-the-first-life-forms-on-this-planet}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Earth declares its independence about 4600 MYA
\end{enumerate}

\includegraphics[width=1\textwidth,height=\textheight]{./Figures/4billionyrs.png}
\includegraphics[width=1\textwidth,height=\textheight]{./Figures/Planets.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  First photosynthetic bacteria 3.4 billion years ago (BYA)
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Used sunlight for energy to create biomass
\item
  Anaerobic (anoxic photosynthesis)
\end{itemize}

\begin{figure}
\centering
\includegraphics[width=1\textwidth,height=\textheight]{./Figures/Stromatolite.png}
\caption{3.4 billion year old Stromatolite fossil}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=1\textwidth,height=\textheight]{./Figures/Stromatolites_in_sharkbay.png}
\caption{Modern Stromatolites \url{https://en.wikipedia.org/wiki/Stromatolite}}
\end{figure}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\tightlist
\item
  2.7 BYA first oxygen producers emerge
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Oxygen as waste product during respiration
\item
  Most of the oxygen was sequestered and not readily available
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{3}
\tightlist
\item
  2.3 BYA atmosphere has oxygen
\item
  500 million year ago (MYA) first terrestrial plants
\item
  200 MYA mammals emerged
\item
  13 MYA one of us makes all of us proud by learning how to fly
\item
  10 MYA the branch of life currently called homo emerges
\item
  400 years ago humans observe the first microbe under
  a simple scope
\end{enumerate}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/natgeo.png}
\caption{History of life on earth}
\end{figure}

\url{https://education.nationalgeographic.org/resource/age-earth/\#undefined}

\hypertarget{there-would-be-no-life-without-microbes}{%
\subsubsection*{THERE WOULD BE NO LIFE WITHOUT MICROBES}\label{there-would-be-no-life-without-microbes}}
\addcontentsline{toc}{subsubsection}{THERE WOULD BE NO LIFE WITHOUT MICROBES}

\hypertarget{microbes-enable-habitability-on-earth-by-catalyzing-reactions-of-biogeochemical-cycles}{%
\subsection{Microbes enable habitability on Earth by catalyzing reactions of biogeochemical cycles}\label{microbes-enable-habitability-on-earth-by-catalyzing-reactions-of-biogeochemical-cycles}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The amount or \% of elements on Earth remains constant
\item
  Recycling of these elements, flux, and bio-availability is
  largely taken care of by microbes
\item
  Best example to illustrate -- nitrogen
\end{enumerate}

\begin{itemize}
\tightlist
\item
  78\% of Earths atm is N2
\item
  Required for important biological processes
\item
  In gaseous form it is unavailable
\item
  In fact many processes are N2 limited
\item
  Making N2 bioavailable in a form that can be
  by eukaryotes is completely on the shoulders of microbes
\end{itemize}

\hypertarget{nitrogen-cycle}{%
\subsubsection{Nitrogen Cycle}\label{nitrogen-cycle}}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Nitrogen.png}
\caption{Nitrogen Cycle}
\end{figure}

\url{https://cdn.britannica.com/37/6537-050-CF14602B/ammonia-Nitrogen-fixation-nitrogen-form-means-nitrates-1909.jpg}

\hypertarget{carbon-cycle}{%
\subsubsection{Carbon Cycle}\label{carbon-cycle}}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Carbon2.png}
\caption{Carbon Cycle}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Carbon1.png}
\caption{Carbon Cycle}
\end{figure}

\url{https://www.pmel.noaa.gov/co2/story/Carbon+Cycle}

How many microbes??

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  40 million microbes in a gram of soil
\item
  One million microbes in a ml of fresh water
\item
  One trillion in a human body
\end{enumerate}

\hypertarget{microbes-are-abundantand-extremely-diverse}{%
\subsubsection*{MICROBES ARE ABUNDANT\ldots\ldots AND EXTREMELY DIVERSE!}\label{microbes-are-abundantand-extremely-diverse}}
\addcontentsline{toc}{subsubsection}{MICROBES ARE ABUNDANT\ldots\ldots AND EXTREMELY DIVERSE!}

\hypertarget{how-many-kinds-of-living-beings-are-there}{%
\section{How many kinds of living beings are there?}\label{how-many-kinds-of-living-beings-are-there}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Aristotle's Scala naturae
  = \textbf{350 BC}
\end{enumerate}

\includegraphics[width=0.55\textwidth,height=\textheight]{./Figures/Scala1.png}
\includegraphics[width=0.4\textwidth,height=\textheight]{./Figures/Scala2.png}

\url{https://sites.google.com/site/aristotlethebiologist/aristotle-s-biology/great-chain-of-being}

\begin{figure}
\centering
\includegraphics[width=0.6\textwidth,height=\textheight]{./Figures/Scala3.png}
\caption{Ladder of Ascent and Descent of the Mind, 1305}
\end{figure}

\url{https://upload.wikimedia.org/wikipedia/commons/e/e9/Die_Leiter_des_Auf-_und_Abstiegs.jpg}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  2000 yrs later
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Edward Hitchcock

  \begin{itemize}
  \tightlist
  \item
    1840
  \end{itemize}
\item
\end{itemize}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Hitchcock.png}
\caption{Tree of Life}
\end{figure}

\url{https://upload.wikimedia.org/wikipedia/commons/8/8f/Edward_Hitchcock_Paleontological_Chart.jpg}

\begin{itemize}
\tightlist
\item
  Ernst Haeckel

  \begin{itemize}
  \tightlist
  \item
    1879
  \end{itemize}
\end{itemize}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Haeckel.png}
\caption{Another Tree of Life}
\end{figure}

\url{https://upload.wikimedia.org/wikipedia/commons/d/de/Tree_of_life_by_Haeckel.jpg}

\begin{itemize}
\tightlist
\item
  Charles Darwin

  \begin{itemize}
  \tightlist
  \item
    1837
  \item
    The idea that species could have evolved from an ancestor
  \item
    This could have happened through transmutations
  \item
    Premise for trees today
  \item
    ALL METHODS DEPEND ON \textbf{OBSERVABLE MORPHOLOGICAL TRAITS} FOR CATEGORIZATION
  \end{itemize}
\end{itemize}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Darwin.png}
\caption{Tree of Life sketch}
\end{figure}

\hypertarget{what-happened-when-we-found-out-about-microbes}{%
\section{What happened when we found out about microbes?}\label{what-happened-when-we-found-out-about-microbes}}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Microbes.png}
\caption{Microbes}
\end{figure}

\url{https://hms.harvard.edu/news/diet-gut-microbes-immunity}

\hypertarget{roadmap-to-where-we-are-now-with-determining-microbial-diversity}{%
\subsection*{Roadmap to where we are now with determining microbial diversity}\label{roadmap-to-where-we-are-now-with-determining-microbial-diversity}}
\addcontentsline{toc}{subsection}{Roadmap to where we are now with determining microbial diversity}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Leeuwenhoek
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Father of microbiology
\item
  Late 1600's
\item
  Microscope
\end{itemize}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Microscope.png}
\caption{Original Microscope}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/leeuwenhoeck.png}
\caption{First Sketch of Microbes}
\end{figure}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  Robert Koch
\end{enumerate}

\begin{itemize}
\tightlist
\item
  1890
\item
  First time bringing microbes to the lab
\item
  Cultivation of microbes
\end{itemize}

\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/koch1.png}
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/koch2.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\tightlist
\item
  Discovery of DNA structure
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Rosiland Franklin

  \begin{itemize}
  \tightlist
  \item
    1951
  \end{itemize}
\end{itemize}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Rosalind1.png}
\caption{\url{https://en.wikipedia.org/wiki/Rosalind_Franklin\#/media/File:Rosalind_Franklin_(1920-1958).jpg}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Rosalind2.png}
\caption{--- J. D. Bernal, 1958. Franklin's X-ray diagram of the B form of sodium thymonucleate (DNA) fibres, published in Nature on 25 April 1953, shows ``in striking manner the features characteristic of helical structures''}
\end{figure}

\begin{itemize}
\tightlist
\item
  Frederick Sanger

  \begin{itemize}
  \tightlist
  \item
    1975
  \end{itemize}
\end{itemize}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Sanger1.png}
\caption{\url{https://www.britannica.com/science/DNA-sequencing\#/media/1/422006/40224}}
\end{figure}

\begin{itemize}
\tightlist
\item
  Carl Woese

  \begin{itemize}
  \tightlist
  \item
    1977
  \item
    Archaea
  \item
    Phylogenetic tree based on Woese et al.~rRNA analysis. The vertical line at bottom represents the last universal common ancestor (LUCA).
  \end{itemize}
\end{itemize}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Woese1.png}
\caption{Maulucioni, CC BY-SA 3.0 \url{https://creativecommons.org/licenses/by-sa/3.0}, via Wikimedia Commons}
\end{figure}

\hypertarget{dna-structure}{%
\subsubsection*{DNA Structure}\label{dna-structure}}
\addcontentsline{toc}{subsubsection}{DNA Structure}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/DNA.png}
\caption{\url{https://www.genome.gov/genetics-glossary/Deoxyribonucleic-Acid}}
\end{figure}

\url{https://youtu.be/L9NriBoubWE}

\hypertarget{tree-of-life}{%
\section{Tree of Life}\label{tree-of-life}}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/TreeofLife06.png}
\caption{Ivica Letunic: Iletunic. Retraced by Mariana Ruiz Villarreal: LadyofHats, Public domain, via Wikimedia Commons}
\end{figure}

``Visible organisms represent the smallest sliver of life's diversity. Bacteria are the true lords of the world. They have been on this planet for billions of years and have irrevocably changed it, while diversifying into endless forms most wonderful and most beautiful.'' (The Atlantic)

Life just got weird!

\begin{figure}
\centering
\includegraphics[width=1\textwidth,height=\textheight]{./Figures/TreeofLife16.png}
\caption{Hug, L. A., Baker, B. J., Anantharaman, K., Brown, C. T., Probst, A. J., Castelle, C. J., \ldots{} \& Banfield, J. F. (2016). A new view of the tree of life. Nature microbiology, 1(5), 1-6.}
\end{figure}

\hypertarget{what-makes-microbes-so-special}{%
\section{What Makes Microbes so Special?}\label{what-makes-microbes-so-special}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  -15oC/4oF to 130oC/266oF temperatures
\item
  0 to 12.8 pH acidity
\item
  More than 200 atm pressure
\item
  4 miles deep into Earth's crust
\item
  Up to 5kGy radiation
\end{enumerate}

\hypertarget{grand-prismatic-spring-ynp-183oc}{%
\subsection*{Grand Prismatic Spring -- YNP -- 183oC}\label{grand-prismatic-spring-ynp-183oc}}
\addcontentsline{toc}{subsection}{Grand Prismatic Spring -- YNP -- 183oC}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Validates the importance of microbes and sums up life on Earth with boundaries.
\end{enumerate}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/GrandPrismatic.png}
\caption{Carsten Steger, CC BY-SA 4.0 \url{https://creativecommons.org/licenses/by-sa/4.0}, via Wikimedia Commons}
\end{figure}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\item
  Microbes are constantly trying to evolve and get deeper and deeper into the hot springs
\item
  Eukaryotes only surround this spring -- cannot survive close to the hot spring
\end{enumerate}

\hypertarget{the-great-plate-count-anomaly}{%
\subsection{The great ``plate count'' anomaly}\label{the-great-plate-count-anomaly}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Cultivation based cell counts are orders of magnitude lower than direct microscopic observation
\end{enumerate}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/PlateCount.png}
\caption{Parks, D. H., Rinke, C., Chuvochina, M., Chaumeil, P. A., Woodcroft, B. J., Evans, P. N., \ldots{} \& Tyson, G. W. (2017). Recovery of nearly 8,000 metagenome-assembled genomes substantially expands the tree of life. Nature microbiology, 2(11), 1533-1542.}
\end{figure}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\item
  As microbiologists, we are able to cultivate only a small minority of naturally occurring microbes
\item
  Our nucleic acid derived understanding of microbial diversity has rapidly outpaced our ability to culture new microbes
\end{enumerate}

\hypertarget{total-number-of-genomes-at-ncbi}{%
\subsection{Total number of genomes at NCBI}\label{total-number-of-genomes-at-ncbi}}

\textbf{Most Prokaryotes:}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Haploid genome
\item
  Single circular chromosome, plasmids
\item
  Metabolic diversity
\item
  Genetic malleability
\item
  No nucleus
\item
  Easy interspecies gene transfer
\end{enumerate}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Genomes1.png}
\caption{Plate Count Anomaly}
\end{figure}

\url{https://www.ncbi.nlm.nih.gov/genome/browse/\#!/overview/}

\hypertarget{roadmap-to-culture-independent-techniques}{%
\section{Roadmap to Culture Independent Techniques}\label{roadmap-to-culture-independent-techniques}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  rRNA as an evolutionary marker
\end{enumerate}

\begin{itemize}
\tightlist
\item
  1977
\item
  (Woese and Fox, PNAS)
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  Polymerase Chain Reaction
\end{enumerate}

\begin{itemize}
\tightlist
\item
  1985
\item
  (K. Mullis, Science)
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\tightlist
\item
  ``Universal Primers'' for rRNA sequencing
\end{enumerate}

\begin{itemize}
\tightlist
\item
  1985
\item
  (N. Pace, PNAS)
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{3}
\tightlist
\item
  PCR amplification of 16S rRNA gene
\end{enumerate}

\begin{itemize}
\tightlist
\item
  1989
\item
  (Bottger, FEMS Microbiol)
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{4}
\tightlist
\item
  Curation and hosting of RDP
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Early 1990's
\item
  (rRNA database) FTP
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{5}
\tightlist
\item
  Term `microbiome'
\end{enumerate}

\begin{itemize}
\tightlist
\item
  2001
\item
  coined by Lederberg and McCray
\end{itemize}

\hypertarget{microbiomes-and-their-significance}{%
\section{Microbiomes and their significance}\label{microbiomes-and-their-significance}}

\begin{itemize}
\tightlist
\item
  Microbes do not work or function as a single entity
\item
  Most microbial activities are performed by complex communities of microorganisms

  \begin{itemize}
  \tightlist
  \item
    \textbf{Microbiome}
  \end{itemize}
\end{itemize}

\hypertarget{what-is-a-microbiome}{%
\subsection{What is a microbiome}\label{what-is-a-microbiome}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Totality of microbes in a defined environment, and their intricate interactions with each other and the surrounding environment
\end{enumerate}

\begin{itemize}
\tightlist
\item
  A population of a single species is a culture(monoculture), extremely rare outside of lab and in some infections
\item
  A microbiome is a mixed population of different microbial species
\item
  MIXED COMMUNITY IS THE NORM!
\end{itemize}

\hypertarget{why-study-microbiomes}{%
\subsection{Why Study Microbiomes}\label{why-study-microbiomes}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Microbes modulate and maintain the atmosphere
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Critical elemental cycles (carbon, nitrogen, sulfur, iron,\ldots)
\item
  Pollution control, clean up fuel leaks
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  Microbes keep us healthy
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Protection from pathogens
\item
  Absorption/production of nutrients in the gut
\item
  Role in chronic diseases (obesity, Crohn's/IBD, arthritis\ldots)
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\tightlist
\item
  Microbes support plant growth and suppress plant disease
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Most complex communities reside in soil
\item
  Crop productivity
\end{itemize}

\hypertarget{why-is-microbiome-research-new}{%
\subsection{Why is Microbiome Research New?}\label{why-is-microbiome-research-new}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Bias for microbes (especially pathogens) that are
  cultivable
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Culture-based methods do not detect majority of microbes
\item
  Only pathogens are easily detected
\item
  And most microbes are not pathogens
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  Availability of tools
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Discovery of culture independent techniques
\item
  Amplicon sequencing and DNA sequencing
\end{itemize}

\begin{figure}
\centering
\includegraphics[width=1\textwidth,height=\textheight]{./Figures/MapofMicrobiome.png}
\caption{Morgan, X. C., Segata, N., \& Huttenhower, C. (2013). Biodiversity and functional genomics in the human microbiome. Trends in genetics, 29(1), 51-58.}
\end{figure}

\hypertarget{biodiversity-and-functional-genomics-in-the-human-microbiome}{%
\subsection{Biodiversity and functional genomics in the human microbiome}\label{biodiversity-and-functional-genomics-in-the-human-microbiome}}

\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Metagenome.png}
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Metagenome2.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Recovered over 150,000 microbial genomes from \textasciitilde10,000 metagenomes
\item
  70,178 genomes assembled with higher than 90\% completeness
\item
  3,796 SGBs (species-level genome bins) identified -77\% of the total representing species without any publicly available genomes
\end{enumerate}

\hypertarget{microbiome-projects-and-databases}{%
\subsection{Microbiome Projects and Databases}\label{microbiome-projects-and-databases}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  American Gut Project
\item
  Earth microbiome Project
\item
  Human Oral Microbiome Database
\item
  CardioBiome
\item
  Human Microbiome Studies -- JCVI
\item
  MetaSub -- Metagenomics and metadesign of Subways and Urban Biomes
\item
  Gut microbiota for Health
\item
  NASA: Study of the impact of long term space travel in the Astronaut's
  microbiome
\item
  Michigan microbiome project
\item
  Coral microbiome project
\item
  Seagrass microbiome project
\end{enumerate}

\hypertarget{structural-and-functional-approaches-to-study-microbiomes}{%
\section{Structural and Functional Approaches to study microbiomes}\label{structural-and-functional-approaches-to-study-microbiomes}}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/StructureFunction.png}
\caption{Alves, L. D. F., Westmann, C. A., Lovate, G. L., de Siqueira, G. M. V., Borelli, T. C., \& Guazzaroni, M. E. (2018). Metagenomic approaches for understanding new concepts in microbial science. International journal of genomics, 2018.}
\end{figure}

\hypertarget{s-rrna-as-an-evolutionary-chronometer}{%
\subsection{16S rRNA as an evolutionary chronometer}\label{s-rrna-as-an-evolutionary-chronometer}}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/16s.png}
\caption{Case, R. J., Boucher, Y., Dahllöf, I., Holmström, C., Doolittle, W. F., \& Kjelleberg, S. (2007). Use of 16S rRNA and rpoB genes as molecular markers for microbial ecology studies. Applied and environmental microbiology, 73(1), 278-288.}
\end{figure}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Ubiquitous -- present in all known life (excluding viruses)
\item
  Functionally constant wrt translation and secondary structure
\item
  Evolves very slowly -- mutations are extremely rare
\item
  Large enough to extract information for evolutionary inference
\item
  Limited exchange -- limited examples of rRNA gene sharing between organisms
\end{enumerate}

\hypertarget{s-rrna-vs-rpob-rna-polymerase-ux3b2-subunit-gene}{%
\subsection{16S rRNA vs rpoB (RNA polymerase β subunit gene)}\label{s-rrna-vs-rpob-rna-polymerase-ux3b2-subunit-gene}}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/RpoB.png}
\caption{Case, R. J., Boucher, Y., Dahllöf, I., Holmström, C., Doolittle, W. F., \& Kjelleberg, S. (2007). Use of 16S rRNA and rpoB genes as molecular markers for microbial ecology studies. Applied and environmental microbiology, 73(1), 278-288.}
\end{figure}

\hypertarget{s-rrna-hypervariable-regions}{%
\subsubsection{16S rRNA hypervariable regions}\label{s-rrna-hypervariable-regions}}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Hypervariable1.png}
\caption{Yang, B., Wang, Y., \& Qian, P. Y. (2016). Sensitivity and correlation of hypervariable regions in 16S rRNA genes in phylogenetic analysis. BMC bioinformatics, 17(1), 1-8.}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Hypervariable2.png}
\caption{Yang, B., Wang, Y., \& Qian, P. Y. (2016). Sensitivity and correlation of hypervariable regions in 16S rRNA genes in phylogenetic analysis. BMC bioinformatics, 17(1), 1-8.}
\end{figure}

Illustration of different hypervariable regions of 16S rRNA

\hypertarget{basic-workflow-for-16s-gene-based-sequencing}{%
\section{Basic Workflow for 16S Gene Based Sequencing}\label{basic-workflow-for-16s-gene-based-sequencing}}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Workflow.png}
\caption{Jo, J. H., Kennedy, E. A., \& Kong, H. H. (2016). Research techniques made simple: bacterial 16S ribosomal RNA gene sequencing in cutaneous research. Journal of Investigative Dermatology, 136(3), e23-e27.}
\end{figure}

\hypertarget{addressing-the-fine-print-while-generating-16s-rrna-gene-amplicon-libraries}{%
\section{Addressing the `fine print' while generating 16S rRNA gene amplicon libraries}\label{addressing-the-fine-print-while-generating-16s-rrna-gene-amplicon-libraries}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Sample Collection
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Sample collection significantly influences the microbiome profiler
  after sequencing
\item
  Sample storage
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  DNA isolation
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Template concentration
\item
  Template extraction protocol
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\tightlist
\item
  PCR amplification
\end{enumerate}

\begin{itemize}
\tightlist
\item
  PCR bias and inhibitors
\item
  Amplification of contaminants
\end{itemize}

J. Microbiol Methods (2018), App. Environ. Microbiol. (2014), Microbiome (2015)

\hypertarget{steps-involved}{%
\section{Steps Involved}\label{steps-involved}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Experimental Design: How many samples can be included in the sequencing run?
\end{enumerate}

\begin{itemize}
\tightlist
\item
  By using barcoded primers, numerous samples can be sequenced simultaneously (multiplexing)
\end{itemize}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Barcode.png}
\caption{V4 Region}
\end{figure}

\hypertarget{samples}{%
\subsection{Samples}\label{samples}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  More the number of samples, more cost effective the run (sequencing depth will be compromised)
\end{enumerate}

Comparison of multiplexing capacity by sequencing system

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Multiplex1.png}
\caption{\url{https://www.illumina.com/content/dam/illumina-marketing/documents/products/whitepapers/index-hopping-white-paper-770-2017-004.pdf}}
\end{figure}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  It is critical to have a `library prep manifest' to document the position of each sample with its associated barcode along with additional metadata information
\end{enumerate}

\url{https://www.youtube.com/watch?v=3SEz-i517Oo\&t=5s}

\hypertarget{include-controls}{%
\subsection{Include Controls}\label{include-controls}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Between run repeat (process any sample in duplicate per run to measure reproducibility across runs)
\item
  Within run repeat (process any sample in duplicate per plate to measure reproducibility)
\item
  Water used during PCR (water blank- to determine if any contaminant was introduced during PCR reaction)
\item
  Water spiked with known bacterial DNA (mock bacterial communities- enables quantification of sequencing errors, minimizes bias during sampling and library preparation )
\end{enumerate}

\hypertarget{dna-extraction-protocol}{%
\subsection{DNA extraction protocol}\label{dna-extraction-protocol}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Effect of mechanical lysis methods for extraction
\item
  Presence of inhibitors such as organic matter, humic acid, bile salts, polysaccharides
\item
  DNA yield post extraction and reproducibility
\end{enumerate}

Effect of bead beating was larger than sampling time over 5 months

The effect of bead beating on the observed microbial community composition:

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Beads.png}
\caption{Albertsen, M., Karst, S. M., Ziegler, A. S., Kirkegaard, R. H., \& Nielsen, P. H. (2015). Back to basics--the influence of DNA extraction and primer choice on phylogenetic analysis of activated sludge communities. PloS one, 10(7), e0132783.}
\end{figure}

A. Percentage read abundance of the 11 most abundant phyla as a result of bead beating intensity

B. PCA of samples with different bead beating intensities vs.~samples taken at different dates

\hypertarget{selection-of-primers-and-region-of-16s-gene-influence-microbial-profile}{%
\subsection{Selection of primers and region of 16S gene influence microbial profile}\label{selection-of-primers-and-region-of-16s-gene-influence-microbial-profile}}

V2, V4, V6-V7 regions produced consistent results

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Plos1.png}
\caption{Barb, J. J., Oler, A. J., Kim, H. S., Chalmers, N., Wallen, G. R., Cashion, A., \ldots{} \& Ames, N. J. (2016). Development of an analysis pipeline characterizing multiple hypervariable regions of 16S rRNA using mock samples. PLoS One, 11(2), e0148047.}
\end{figure}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  V2, V3 and V6 contain maximum nucleotide heterogeneity
\item
  V6 is the shortest hypervariable region
  with the maximum sequence
  heterogeneity
\item
  V1 is best target for distinguishing
  pathogenic S aureus
\item
  V2 and V3 are excellent targets for
  speciation among Staph and Strep pathogens as well as Clostridium and Neisseria species
\item
  V2 especially useful for speciation of Mycobacterium sp. and detection of E coli O157:H7
\item
  V3 useful for speciation of
  Haemophilus sp
\item
  V6 best target for probe based PCR assays to identify CDC select agents (bio-terrorism agents)
\end{enumerate}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/MicrobialMeth.png}
\caption{Chakravorty, S., Helb, D., Burday, M., Connell, N., \& Alland, D. (2007). A detailed analysis of 16S ribosomal RNA gene segments for the diagnosis of pathogenic bacteria. Journal of microbiological methods, 69(2), 330-339.}
\end{figure}

\hypertarget{purification-of-amplicons}{%
\subsection{Purification of Amplicons}\label{purification-of-amplicons}}

After one --step or two-step PCR, products are cleaned up using AMpure beads

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Ampure.png}
\caption{\url{https://research.fredhutch.org/content/dam/stripe/hahn/methods/mol_biol/Agencourt\%20AMPure\%20XP.pdf}}
\end{figure}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Gel Electrophoresis and quantification of cleaned amplicon products
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Qubit
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  Sample pooling -- equimolar concentrations (how many samples do you want to pool? How many reads per sample?
\item
  Gel extraction of pooled product
\item
  Final clean up (Qiagen kit) and QC
\end{enumerate}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/LibSum.png}
\caption{16S Library Prep}
\end{figure}

\href{https://www.pacb.com/wp-content/uploads/Multiplexed-Amplicon-Library-Preparation-Using-SMRTbell-Express-Template-Prep-Kit-2.0-–-Customer-Training.pdf}{Amplicon Sequencing Library Prep - PacBio}

\hypertarget{overview-of-generic-amplicon-workflow}{%
\subsubsection{Overview of generic amplicon workflow}\label{overview-of-generic-amplicon-workflow}}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/NCGRwkflo.png}
\caption{Amplicon Workflow}
\end{figure}

\begin{verbatim}
knitr::write_bib(c(
  .packages(), 'bookdown', 'knitr', 'rmarkdown'
), 'packages.bib')
\end{verbatim}

\hypertarget{filter-out-red-alder-sequencing-reads}{%
\chapter{Filter out Red Alder Sequencing Reads}\label{filter-out-red-alder-sequencing-reads}}

\includegraphics[width=0.4\textwidth,height=\textheight]{Figures/AlderTree.png}
\includegraphics[width=0.4\textwidth,height=\textheight]{Figures/AlderNodule.png}

In order to focus on sequencing reads from the microbes in the nodule, we will filter out reads that align to the red alder genome as follows:

1 Align the fastq-formatted reads to the red alder genome using minimap2.
2 Extract reads that do not align to red alder and sort them using samtools.
3 Create a fastq file with only the unaligned reads using samtools bam2fastq.
4 Compress the fastq file using gzip.

\hypertarget{activate-the-environment-that-contains-minimap2}{%
\section{Activate the environment that contains minimap2}\label{activate-the-environment-that-contains-minimap2}}

\includegraphics[width=0.8\textwidth,height=\textheight]{Figures/minimap2.png}

\begin{verbatim}
conda activate minimap2
\end{verbatim}

\begin{itemize}
\tightlist
\item
  Make a directory and go into it
\end{itemize}

\begin{verbatim}
mkdir ~/microbe_fastq
cd ~/microbe_fastq
\end{verbatim}

\begin{itemize}
\tightlist
\item
  Link to the merged minion reads
\end{itemize}

\begin{verbatim}
ln -s /home/cjb/minion/2022/data/AlderNodule3469-3/3469-3/20220701_2144_MC-113445_FAS21661_134c02ac/fastq_pass/all.fastq 3469-3.all.fastq
\end{verbatim}

\begin{itemize}
\tightlist
\item
  Run Minimap2 to align the MinION reads to the red alder genome

  \begin{itemize}
  \tightlist
  \item
    he -x map-ont parameter (allows \textasciitilde10\% error + divergence)
  \end{itemize}
\end{itemize}

\begin{verbatim}
minimap2 -x map-ont -L -t 8 -a \
/home/cjb/indexes/red_alder_genome/consensus.fasta \
3469-3.all.fastq > 3469-3-minionxredalder.mm2.sam
\end{verbatim}

\hypertarget{activate-the-environment-that-contains-samtools}{%
\section{Activate the environment that contains samtools}\label{activate-the-environment-that-contains-samtools}}

\includegraphics[width=0.8\textwidth,height=\textheight]{Figures/samtools.png}

\begin{verbatim}
conda activate samtools
\end{verbatim}

\begin{itemize}
\tightlist
\item
  Convert the unmapped reads in the alignment file (sam) to a fastq file

  \begin{itemize}
  \tightlist
  \item
    The -f4 includes only reads with the 4 flag (unmapped)
  \end{itemize}
\end{itemize}

\begin{verbatim}
samtools fastq -f4 3469-3-minionxredalder.mm2.sam > 3469-3.microbe.fq
\end{verbatim}

\begin{itemize}
\tightlist
\item
  Compress the new fastq file

  \begin{itemize}
  \tightlist
  \item
    (note that it will automatically add the extension .gz)
  \end{itemize}
\end{itemize}

\begin{verbatim}
gzip 3469-3.microbe.fq
\end{verbatim}

\hypertarget{now-run-these-steps-with-4956-3}{%
\subsection*{Now run these steps with 4956-3}\label{now-run-these-steps-with-4956-3}}
\addcontentsline{toc}{subsection}{Now run these steps with 4956-3}

Reads are here:

\begin{verbatim}
/home/cjb/minion/2022/data/Aldernodule4956-3/4956-3/20220701_2154_MC-113286_FAS37509_f3119554/fastq_pass/all.fastq
\end{verbatim}

\hypertarget{data-processing}{%
\chapter{Data Processing}\label{data-processing}}

\hypertarget{fastqc}{%
\section{FastQC}\label{fastqc}}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Planets.png}
\caption{FastQC}
\end{figure}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Many tools/options to filter and trim data
\item
  Trimming does not always improve things as valuable information
  can be lost!
\item
  Removal of adapters is critical for downstream analysis
\end{enumerate}

\hypertarget{dereplication}{%
\section{Dereplication}\label{dereplication}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  In this process all the quality-filtered sequences are collapsed into a set of unique reads, which are then clustered into OTUs
\item
  Dereplication step significantly reduces computation time by eliminating redundant sequences
\end{enumerate}

\hypertarget{chimera-detection-and-removal-of-non-bacterial-sequences}{%
\section{Chimera detection and removal of non-bacterial sequences}\label{chimera-detection-and-removal-of-non-bacterial-sequences}}

Chimeras as artifact sequences formed by two or more biological sequences incorrectly joined together

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Planets.png}
\caption{Chimera}
\end{figure}

Incomplete extensions during PCR allow subsequent PCR cycles to use a partially extended strand to bind to the template of a different, but similar, sequence. This partially extended strand then acts as a primer to extend and form a chimeric sequence.

\hypertarget{clustering}{%
\section{Clustering}\label{clustering}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Analysis of 16S rRNA relies on clustering of related sequences at a particular level of identity and counting the representatives of each cluster
\end{enumerate}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Planets.png}
\caption{Clustering}
\end{figure}

Some level of sequence divergence should be allowed -- 95\% (genus-level, partial 16S gene), 97\% (species-level) or 99\% typical similarity cutoffs used in
practice and the resulting cluster of nearly identical tags (assumedly identical genomes) is referred to as an OTU (Operational Taxonomic Unit)

\hypertarget{create-otu-tables}{%
\section{Create OTU tables}\label{create-otu-tables}}

OTU table is a matrix that gives the number of reads per sample per OTU

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Planets.png}
\caption{OTUs}
\end{figure}

\hypertarget{bin-otus-into-taxonomy-assign-taxonomy}{%
\section{Bin OTUs into Taxonomy (assign taxonomy)}\label{bin-otus-into-taxonomy-assign-taxonomy}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Accuracy of assigning taxonomy depends on the
  reference database chosen
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Ribosomal Database Project
\item
  GreenGenes
\item
  SILVA
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  Accuracy depends on the completeness of databases
\end{enumerate}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Planets.png}
\caption{Database}
\end{figure}

\hypertarget{assess-population-diversity-alpha-diversity}{%
\section{\texorpdfstring{Assess Population Diversity: \textbf{alpha diversity}}{Assess Population Diversity: alpha diversity}}\label{assess-population-diversity-alpha-diversity}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Assessment of diversity involves two aspects
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Species richness (\# of species present in a sample)
\item
  Species evenness (distribution of relative abundance of species)
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\item
  Total community diversity of a single sample/environment is given by alpha-diversity and represented using rarefaction curves
\item
  Quantitative methods such as Shannon or Simpson indices measure evenness of the alpha- diversity
\end{enumerate}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Planets.png}
\caption{Human Mol. Genet., 2013}
\end{figure}

\hypertarget{assess-beta-diversity}{%
\section{Assess Beta Diversity}\label{assess-beta-diversity}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Beta-diversity measures community structure differences (taxon composition and relative abundance) between two or more samples
\end{enumerate}

\begin{itemize}
\tightlist
\item
  For example, beta-diversity indices can compare similarities and differences in microbial communities in healthy and diseases states
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  Many qualitative (presence/absence taxa) and
  quantitative(taxon abundance) measures of community
  distance are available using several tools
\end{enumerate}

\begin{itemize}
\tightlist
\item
  LIBHUFF, TreeClimber, DPCoA, UniFrac (QIIME)
\end{itemize}

\hypertarget{measuring-population-diversity-alpha-and-beta-diversity}{%
\section{\texorpdfstring{Measuring Population Diversity: \textbf{alpha and beta diversity}}{Measuring Population Diversity: alpha and beta diversity}}\label{measuring-population-diversity-alpha-and-beta-diversity}}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Planets.png}
\caption{PLoS Computational Biol.,2012}
\end{figure}

\hypertarget{diversity-measurements-with-16s-rrna-sequencing}{%
\section{Diversity Measurements with 16s rRNA sequencing}\label{diversity-measurements-with-16s-rrna-sequencing}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Overall Benefits
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Cost effective
\item
  Data analysis can be performed by established pipelines
\item
  Large body of archived data is available for reference
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  Overall Limitations
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Sequences only a single region of the genome
\item
  Classifications often lack accuracy at the
  species level
\item
  Copy number per genome can vary. While they
  tend to be taxon specific, variation among
  strains is possible
\item
  Relative abundance measurements are
  unreliable because of amplification biases
\item
  Diversity of the gene tends to overinflate
  diversity estimates
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\tightlist
\item
  FastQC for 16S rRNA dataset
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Extremely biased per base sequence content
\item
  Extremely narrow distribution of GC content
\item
  Very high sequence duplication levels
\item
  Abundance of overrepresented sequences
\item
  In cases where the PCR target is shorter than the read length, the sequence will read through into adapters
\end{itemize}

\hypertarget{taxonomy-expectation-vs-reality}{%
\section{Taxonomy: Expectation vs Reality}\label{taxonomy-expectation-vs-reality}}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Planets.png}
\caption{Expectation vs.~Reality}
\end{figure}

\hypertarget{beta-diversity---unifrac}{%
\section{Beta Diversity - UniFrac}\label{beta-diversity---unifrac}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Measures how different two samples' component sequences are
\end{enumerate}

\begin{figure}
\centering
\includegraphics[width=0.8\textwidth,height=\textheight]{./Figures/Planets.png}
\caption{Unifrac}
\end{figure}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  Weighted Unifrac: takes abundance of each sequence into account
\end{enumerate}

\hypertarget{results-from-paper}{%
\section{Results from Paper}\label{results-from-paper}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Main phyla: Firmicutes, Bacteroidetes, Proteobacteria, Actinobacteria, Fusobacteria with differences bw samples
\item
  Sputum (patient) samples had highest diversity followed by oropharynx samples followed by nasal
\item
  Healthy controls (N and O) more diverse than samples from TB patients
\item
  Between-group comparisons?
\item
  Phyla differences?
\end{enumerate}

\hypertarget{pycoqc}{%
\chapter{PycoQC}\label{pycoqc}}

\hypertarget{quality-control}{%
\subsection*{Quality Control}\label{quality-control}}
\addcontentsline{toc}{subsection}{Quality Control}

\begin{itemize}
\tightlist
\item
  ``PycoQC computes metrics and generates interactive QC plots for Oxford Nanopore technologies sequencing data'' (\url{https://a-slide.github.io/pycoQC/} )
\end{itemize}

\includegraphics[width=0.25\textwidth,height=\textheight]{Figures/Pyco2.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  What do we need in order to run a Quality Control Check?
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Sequencing Summary File

  \begin{itemize}
  \tightlist
  \item
    Automatically produced by the MinIon basecaller.
  \end{itemize}
\item
  PycoQC package + dependencies

  \begin{itemize}
  \tightlist
  \item
    Already downloaded for you in Logrus.
  \end{itemize}
\item
  Line of code to produce .html file.
\item
  Line of code to secure copy file to your computer.
\end{itemize}

\hypertarget{sequencing-summary-file}{%
\section{Sequencing Summary File}\label{sequencing-summary-file}}

Where is it?

\begin{verbatim}
/home/cjb/minion/2022/data/AlderNodule3469-3/3469-3/20220701_2144_MC-113445_FAS21661_134c02ac/sequencing_summary_FAS21661_9ac87089.txt
\end{verbatim}

\hypertarget{pycoqc-package-code}{%
\section{PycoQC package \& code}\label{pycoqc-package-code}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Where is it? How to activate it?
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Log in to Logrus
\item
  Stay in your home directory (check with pwd)
\item
  Type the following:
\end{itemize}

\begin{verbatim}
source activate seqtools
pycoQC
pycoQC –f inputfilename.txt –o outputfilename.html
\end{verbatim}

\hypertarget{secure-copy}{%
\section{Secure Copy}\label{secure-copy}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  What terminal to copy from? What is the code?
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Open new Terminal window (Not Logrus, but keep Logrus terminal window open)\\
\item
  Type:
\end{itemize}

\begin{verbatim}
scp username@logrus.training.ncgr.org:/home/username/outputfile.html ~/Desktop/
\end{verbatim}

\hypertarget{open-your-url}{%
\section{Open your URL}\label{open-your-url}}

Find your file on your desktop.

Double-click to open, or right-click to select browser

\begin{figure}
\centering
\includegraphics[width=1\textwidth,height=\textheight]{Figures/PycoQC.png}
\caption{\url{https://a-slide.github.io/pycoQC/}}
\end{figure}

\hypertarget{normalization}{%
\subsection{Normalization}\label{normalization}}

With normalization we are trying to get the correct relative gene expression abundances between cells.

Gene expression between cells is based on count data.

What does a count in a count matrix represent?

\begin{itemize}
\tightlist
\item
  mRNA Capture
\item
  Reverse transcription of mRNA
\item
  sequencing of a molecule of mRNA
\end{itemize}

The most common normalization protocol is:

\begin{itemize}
\tightlist
\item
  count depth scaling
\item
  aka CPM or counts per million
\item
  it assumes that all cells in the dataset initially contain an equal number of mRNA molecules
\item
  it assumes that count depth differences arise from sampling
\end{itemize}

Normalize complete

\begin{itemize}
\tightlist
\item
  But wait!
\item
  We still have unwanted variability in the data.
\item
  What kind of unwanted variability?
\item
  What is the solution? Data Correction.
\end{itemize}

\hypertarget{data-correction-and-integration}{%
\subsection{Data correction and integration}\label{data-correction-and-integration}}

Biological Covariates

\begin{itemize}
\tightlist
\item
  Cell-Cycle effects
\item
  Batch
\item
  Dropout
\end{itemize}

Which Covariates to Consider?

\begin{itemize}
\tightlist
\item
  Depends on downstream analysis
\item
  Correct for biological and technical to be considered separately
\item
  Corrections are used for different purposes
\item
  Each approach to correction presents unique challenges
\end{itemize}

What are the Correction methods?

\begin{itemize}
\tightlist
\item
  Regressing out biological effects
\item
  Regressing out technical effects
\item
  Batch effects and data integration
\item
  Expression recovery
\end{itemize}

\hypertarget{krakenuniq}{%
\chapter{KrakenUniq}\label{krakenuniq}}

``confident and fast metagenomics classification using unique k-mer counts''

Default kmer = 31

\begin{figure}
\centering
\includegraphics[width=0.6\textwidth,height=\textheight]{./Figures/KrakenUniq.png}
\caption{KrakenUniq Overview}
\end{figure}

\url{https://genomebiology.biomedcentral.com/articles/10.1186/s13059-018-1568-0}

\url{https://github.com/fbreitwieser/krakenuniq}

\url{https://gitlab.umiacs.umd.edu/derek/krakenuniq/-/blob/master/MANUAL.md}

\hypertarget{krakencentrifuge-family}{%
\section{Kraken/Centrifuge Family}\label{krakencentrifuge-family}}

\textbf{Kraken 1} is obsolete.

\textbf{Centrifuge} was written to improve Kraken's memory issues. It is completely new code with a different classification index. Its databases are also much smaller. Centrifuge can assign a sequence to multiple taxa. We'll use centrifuge later in the course.

\textbf{KrakenUniq} is based on Kraken 1. Adds an efficient algorithm to assess coverage of unique kmers, running at the same speed and with only slightly more memory than Kraken 1. KrakenUniq distinguishes low abundance organisms from false positives.

\textbf{Kraken 2} uses ``probabilistic data structures'' to reduce memory and increase speed at the expense of lower accuracy that leads to false positives during the classifications (``a few dozen out of millions'').

\textbf{KrakenUniq} was updated in May 2022 (v0.7+) that helped to deal with the large databases on computers without enough RAM to load them into memory. Databases can be read in chunks that fit in RAM.

\begin{figure}
\centering
\includegraphics[width=0.5\textwidth,height=\textheight]{./Figures/krakenFix.png}
\caption{Kraken preload}
\end{figure}

KrakenUniq gives you k-mer coverage information, reporting the number and percentage k-mers hit by reads. This helps to differentiate between false positives and good classifications.

\begin{figure}
\centering
\includegraphics[width=0.5\textwidth,height=\textheight]{./Figures/align.png}
\caption{Alignment}
\end{figure}

\url{https://www.biorxiv.org/content/10.1101/2022.06.01.494344v1.full.pdf}

\url{http://ccb.jhu.edu/software/choosing-a-metagenomics-classifier/\#}:\textasciitilde:text=However\%2C\%20while\%20Kraken\%20provides\%20only,1\%20databases\%2C\%20not\%20Kraken\%202.

\url{https://github.com/fbreitwieser/krakenuniq/blob/master/MANUAL.md}

\hypertarget{krakenuniq-databases}{%
\section{KrakenUniq databases}\label{krakenuniq-databases}}

KrakenUniq requires Kraken1 not Kraken2 databases

We won't build a database since it can take several days, but let's look at the documentation:\\
\url{https://github.com/fbreitwieser/krakenuniq\#database-building}

You can also get prebuilt databases:\\
\url{https://benlangmead.github.io/aws-indexes/k2}

We will use a bacterial databases located here:\\
/home/cjb/indexes/krakenuniq/db\_052422

Link to it.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ln} \AttributeTok{{-}s}\NormalTok{ /home/cjb/indexes/krakenuniq/db\_052422/ .}
\end{Highlighting}
\end{Shaded}

The taxa it contains are here:\\
/home/cjb/indexes/krakenuniq/db\_052422/library/bacteria/library\_headers.orig

Take a look at the file.
How many sequences are there?

How many genera?

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{awk} \StringTok{\textquotesingle{}\{print $2\}\textquotesingle{}}\NormalTok{ /home/cjb/indexes/krakenuniq/db\_052422/library/bacteria/library\_headers.orig }\KeywordTok{|} \FunctionTok{sort} \AttributeTok{{-}u}\KeywordTok{|} \FunctionTok{wc} \AttributeTok{{-}l}
\end{Highlighting}
\end{Shaded}

And how many of each genera?

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{awk} \StringTok{\textquotesingle{}\{print $2\}\textquotesingle{}}\NormalTok{ /home/cjb/indexes/krakenuniq/db\_052422/library/bacteria/library\_headers.orig }\KeywordTok{|} \FunctionTok{sort} \KeywordTok{|} \FunctionTok{uniq} \AttributeTok{{-}c} \KeywordTok{|} \FunctionTok{less}
\end{Highlighting}
\end{Shaded}

\hypertarget{run-krakenuniq}{%
\section{Run KrakenUniq}\label{run-krakenuniq}}

Make a working directory and go into it.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mkdir}\NormalTok{ \textasciitilde{}/krakenuniq}
\BuiltInTok{cd}\NormalTok{ \textasciitilde{}/krakenuniq}
\end{Highlighting}
\end{Shaded}

Activate the KrakenUniq environment.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{source}\NormalTok{ activate krakenuniq}
\end{Highlighting}
\end{Shaded}

Run Kraken on sample 3469-3.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{time}\NormalTok{ krakenuniq }\DataTypeTok{\textbackslash{}}
    \AttributeTok{{-}{-}db}\NormalTok{ /home/cjb/indexes/krakenuniq/db\_052422 }\DataTypeTok{\textbackslash{}}
    \AttributeTok{{-}{-}threads}\NormalTok{ 32 }\DataTypeTok{\textbackslash{}}
    \AttributeTok{{-}{-}report{-}file}\NormalTok{ 3469{-}3.report }\DataTypeTok{\textbackslash{}}
    \AttributeTok{{-}{-}unclassified{-}out}\NormalTok{ 3469{-}3.unclassified.fna }\DataTypeTok{\textbackslash{}}
    \AttributeTok{{-}{-}classified{-}out}\NormalTok{ 3469{-}3.classified.fna }\DataTypeTok{\textbackslash{}}
\NormalTok{    \textasciitilde{}/microbe\_fastq/3469{-}3.microbe.fq.gz }\DataTypeTok{\textbackslash{}}
    \OperatorTok{\textgreater{}}\NormalTok{ 3469{-}3.krakenuniqoutput}
\end{Highlighting}
\end{Shaded}

Make sure you got the following files:
3469-3.classified.fna
3469-3.krakenuniqoutput
3469-3.report
3469-3.unclassified.fna

This command will also bring up the input file as well (3469-3.microbe.fq.gz)

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ls}\NormalTok{ 3469}\PreprocessorTok{*}
\end{Highlighting}
\end{Shaded}

Use the less command to look at each of them.

Now run it on the other samples.

\hypertarget{pavian}{%
\section{Pavian}\label{pavian}}

Copy the reports to your computer.
Let's open them in Pavian.

Information on installing and some things you can do in Pavian is in the Centrifuge chapter.

\hypertarget{qiime2}{%
\chapter{QIIME2}\label{qiime2}}

\hypertarget{hands-on-command-line-tutorial}{%
\section{Hands On Command Line Tutorial}\label{hands-on-command-line-tutorial}}

=======

\hypertarget{qiime2-1}{%
\chapter{QIIME2}\label{qiime2-1}}

Command Line Tutorial

\hypertarget{logging-on-to-the-server}{%
\section{Logging on to the server}\label{logging-on-to-the-server}}

Make it a practice to start a screen before you begin analysis.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ssh} \AttributeTok{{-}p}\NormalTok{ 44111 }\OperatorTok{\textless{}}\NormalTok{USERNAME}\OperatorTok{\textgreater{}}\NormalTok{@gateway.training.ncgr.org}

\ExtensionTok{screen} \AttributeTok{{-}S}\NormalTok{ QIIME2}
\end{Highlighting}
\end{Shaded}

\hypertarget{setting-up-a-working-directory-for-qiime2-analysis}{%
\section{Setting up a working directory for QIIME2 analysis}\label{setting-up-a-working-directory-for-qiime2-analysis}}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{cd}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/}

\FunctionTok{mkdir}\NormalTok{ QIIME2\_Analysis}

\BuiltInTok{cd}\NormalTok{ QIIME2\_Analysis}
\end{Highlighting}
\end{Shaded}

\hypertarget{dataset-for-analysis}{%
\section{Dataset for analysis}\label{dataset-for-analysis}}

For this tutorial, we will use data from the following published manuscript:
\url{https://microbiomejournal.biomedcentral.com/articles/10.1186/2049-2618-2-29}

Respiratory tract clinical sample selection for microbiota analysis in patients with pulmonary tuberculosis

Pulmonary Tuberculosis (The Human Microbiome in the Fight Against Tuberculosis, 2017)

\includegraphics[width=1\textwidth,height=\textheight]{./QIIMEpics/lyx.qiime.png}
Why study microbiome in relation to TB?
1. Microbiome composition is a potential risk factors for TB infection and disease susceptibility, disease progression,
and treatment outcomes
2. TB infection and disease can affect microbiome, subsequently impacting health via alteration of immune responses

This pilot study was carried out using sputum, oropharynx, and nasal respiratory tract samples collected from patients
with pulmonary tuberculosis and healthy control individuals, in order to compare sample types and their usefulness in
assessing changes in bacterial and fungal communities.

\hypertarget{data-download}{%
\section{Data download}\label{data-download}}

Data was downloaded from the National Center for Biotechnology Information (NCBI) based on the SRA accession
numbers reported in the manuscript - PRJNA242354.
A program called fastq-dump version 2.10.0 was used to download the data directly from NCBI SRA database. Tbe
following exercise will help you use fastq-dump for your own projects too.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{source}\NormalTok{ activate fastqdump}
\CommentTok{\# MAKE SURE YOU ARE IN THE FOLLOWING FOLDER}
\ExtensionTok{/home/}\VariableTok{$USER}\ExtensionTok{/QIIME2\_Analysis}
\CommentTok{\# CREATE A FOLDER FOR DOWNLOADING FASTQ FILES TO ANALYZE}

\FunctionTok{mkdir}\NormalTok{ input\_data}
\BuiltInTok{cd}\NormalTok{ input\_data}
\ExtensionTok{fastq{-}dump} \AttributeTok{{-}{-}gzip} \AttributeTok{{-}{-}outdir}\NormalTok{ ./ }\DataTypeTok{\textbackslash{}}
\NormalTok{SRR1204628 SRR1204630 SRR1204627 SRR1204629 SRR1204626 SRR1204623 }\DataTypeTok{\textbackslash{}}
\NormalTok{SRR1204625 SRR1204624 SRR1204622 SRR1204631 SRR1204638 SRR1204642 }\DataTypeTok{\textbackslash{}}
\NormalTok{SRR1204633 SRR1204632 SRR1204634 SRR1204639 SRR1204646 SRR1204647 }\DataTypeTok{\textbackslash{}}
\NormalTok{SRR1204641 SRR1204640 SRR1204636 SRR1204637 SRR1369696 SRR1369694 }\DataTypeTok{\textbackslash{}}
\NormalTok{SRR1204635 SRR1204643 SRR1204644 SRR1204645 SRR1369709 SRR1369707 }\DataTypeTok{\textbackslash{}}
\NormalTok{SRR1369690 SRR1369691 SRR1369692 SRR1369693 SRR1369710 SRR1369713 }\DataTypeTok{\textbackslash{}}
\NormalTok{SRR1204650 SRR1204651 SRR1369688 SRR1369689 SRR1369695 SRR1204649 }\DataTypeTok{\textbackslash{}}
\NormalTok{SRR1204648 SRR1369697 SRR1369704 SRR1369703 SRR1369706 SRR1369705 }\DataTypeTok{\textbackslash{}}
\NormalTok{SRR1369708 SRR1369698 SRR1369699 SRR1369701 SRR1369700 SRR1369702 }\DataTypeTok{\textbackslash{}}
\NormalTok{SRR1369714 SRR1369717 SRR1369716 SRR1369715 SRR1369711 SRR1369712}
\CommentTok{\# {-}{-}outdir {-}\textgreater{} Path to Output directory}
\CommentTok{\# {-}{-}gzip {-}\textgreater{} Compress output files using gzip}

\CommentTok{\# After running this step, you will have 60 files in your input\_data folder}
\CommentTok{\# To check, cd into folder that has fastq files, type this command}
\FunctionTok{ls} \AttributeTok{{-}l} \KeywordTok{|} \FunctionTok{wc} \AttributeTok{{-}l}
\CommentTok{\# Optional exercise:}
\CommentTok{\# Count the number of sequences in the two fastq files pertaining to one sample and sum them.}
\ExtensionTok{conda}\NormalTok{ deactivate}
\end{Highlighting}
\end{Shaded}

\hypertarget{quality-control-1}{%
\section{Quality Control}\label{quality-control-1}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Filter poor quality reads}
\BuiltInTok{source}\NormalTok{ activate fastp}

\ControlFlowTok{for}\NormalTok{ file }\KeywordTok{in} \PreprocessorTok{*}\NormalTok{.fastq}\KeywordTok{;} \ControlFlowTok{do} \ExtensionTok{fastp} \AttributeTok{{-}i} \VariableTok{$\{file\}} \AttributeTok{{-}o} \VariableTok{$\{file\}}\NormalTok{.filtered}\KeywordTok{;} \ControlFlowTok{done}
\ExtensionTok{conda}\NormalTok{ deactivate}
\end{Highlighting}
\end{Shaded}

\includegraphics[width=1\textwidth,height=\textheight]{/Users/elavelle/Desktop/Metagenomics-Bookdown/QIIMEpics/lyx.qiime.table.png}
Data was collected from 30 Individuals.

• 6 TB Patients - Nasal

• 6 TB Patients - oropharynx

• 6 TB Patients - Sputum

• 6 Healthy Controls - Nasal

• 6 Healthy Controls - oropharynx

DATA TABLE:

\begin{verbatim}
SAMPLE FASTA FILE                   TOTAL NUMBER OF READS 
Control_1_Nasal_L001_R1_001.fasta   41056
Control_1_Pharynx_L001_R1_001.fasta 119972
Control_2_Nasal_L001_R1_001.fasta   32142
Control_2_Pharynx_L001_R1_001.fasta 42973
Control_3_Nasal_L001_R1_001.fasta   32953
Control_3_Pharynx_L001_R1_001.fasta 39148
Control_4_Nasal_L001_R1_001.fasta   83174
Control_4_Pharynx_L001_R1_001.fasta 17475
Control_5_Nasal_L001_R1_001.fasta   29146
Control_5_Pharynx_L001_R1_001.fasta 32728
Control_6_Nasal_L001_R1_001.fasta   32738
Control_6_Pharynx_L001_R1_001.fasta 15320
Patient_1_Nasal_L001_R1_001.fasta   69995
Patient_1_Pharynx_L001_R1_001.fasta 59646
Patient_1_Sputum_L001_R1_001.fasta  66725
Patient_2_Nasal_L001_R1_001.fasta   61070
Patient_2_Pharynx_L001_R1_001.fasta 27106
Patient_2_Sputum_L001_R1_001.fasta  71434
Patient_3_Nasal_L001_R1_001.fasta   91920
Patient_3_Pharynx_L001_R1_001.fasta 36224
Patient_3_Sputum_L001_R1_001.fasta  27533
Patient_4_Nasal_L001_R1_001.fasta   28996
Patient_4_Pharynx_L001_R1_001.fasta 30713
Patient_4_Sputum_L001_R1_001.fasta  59433
Patient_5_Nasal_L001_R1_001.fasta   70843
Patient_5_Pharynx_L001_R1_001.fasta 39674
Patient_5_Sputum_L001_R1_001.fasta  29576
Patient_6_Nasal_L001_R1_001.fasta   106178
Patient_6_Pharynx_L001_R1_001.fasta 58956
Patient_6_Sputum_L001_R1_001.fasta  35703
\end{verbatim}

\hypertarget{what-is-qiime2}{%
\section{What is QIIME2?}\label{what-is-qiime2}}

\url{https://docs.qiime2.org/2020.11/about/}

QIIME 2 is a powerful microbiome analysis package with a focus on data and analysis transparency. QIIME2 enables researchers to start an analysis with raw DNA sequence data and finish with publication-quality figures and statistical results.

Key features:

• Integrated and automatic tracking of data provenance

• Plugin system for extending microbiome analysis functionality

• Support for multiple types of user interfaces (e.g.~API, command line, graphical)

Plugin availability - \url{https://docs.qiime2.org/2020.11/plugins/available/}

\hypertarget{metadata-setup}{%
\section{Metadata setup}\label{metadata-setup}}

Metadata file that we will be using for our data set: (mappingFile.txt on logrus)

Here is how you will make a metadata file on your own: \url{https://docs.qiime2.org/2017.6/tutorials/metadata/}

\begin{verbatim}
#SampleID   Treatment   TreatmentSite   TreatmentNumber     Sex     BodySite    Description 
C_1_N   C   CN  1   F   Nasal       Control 1 Nasal 
C_1_P   C   CP  2   F   Oropharynx  Control 1 Pharynx 
C_2_N   C   CN  1   M   Nasal       Control 2 Nasal 
C_2_P   C   CP  2   M   Oropharynx  Control 2 Pharynx 
C_3_N   C   CN  1   M   Nasal       Control 3 Nasal 
C_3_P   C   CP  2   M   Oropharynx  Control 3 Pharynx 
C_4_N   C   CN  1   M   Nasal       Control 4 Nasal 
C_4_P   C   CP  2   M   Oropharynx  Control 4 Pharynx 
C_5_N   C   CN  1   M   Nasal       Control 5 Nasal 
C_5_P   C   CP  2   M   Oropharynx  Control 5 Pharynx 
C_6_N   C   CN  1   M   Nasal       Control 6 Nasal 
C_6_P   C   CP  2   M   Oropharynx  Control 6 Pharynx 
P_1_N   P   PN  3   F   Nasal       Patient 1 Nasal 
P_1_P   P   PP  4   F   Oropharynx  Patient 1 Pharynx 
P_1_S   P   PS  5   F   Sputum      Patient 1 Sputum 
P_2_N   P   PN  3   M   Nasal       Patient 2 Nasal 
P_2_P   P   PP  4   M   Oropharynx  Patient 2 Pharynx 
P_2_S   P   PS  5   M   Sputum      Patient 2 Sputum 
P_3_N   P   PN  3   M   Nasal       Patient 3 Nasal 
P_3_P   P   PP  4   M   Oropharynx  Patient 3 Pharynx 
P_3_S   P   PS  5   M   Sputum      Patient 3 Sputum 
P_4_N   P   PN  3   M   Nasal       Patient 4 Nasal 
P_4_P   P   PP  4   M   Oropharynx  Patient 4 Pharynx 
P_4_S   P   PS  5   M   Sputum      Patient 4 Sputum 
P_5_N   P   PN  3   M   Nasal       Patient 5 Nasal 
P_5_P   P   PP  4   M   Oropharynx  Patient 5 Pharynx 
P_5_S   P   PS  5   M   Sputum      Patient 5 Sputum 
P_6_N   P   PN  3   M   Nasal       Patient 6 Nasal 
P_6_P   P   PP  4   M   Oropharynx  Patient 6 Pharynx 
P_6_S   P   PS  5   M   Sputum      Patient 6 Sputum 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Move out of the input\_data directory}

\BuiltInTok{cd}\NormalTok{ ../}

\CommentTok{\# Copy metadata file from my workspace to your workspace,}

\BuiltInTok{cd}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/QIIME2\_Analysis}

\FunctionTok{cp}\NormalTok{ /home/elavelle/QIIME2\_Analysis/mappingFile.txt ./}

\FunctionTok{less}\NormalTok{ mappingFile.txt }
\end{Highlighting}
\end{Shaded}

\hypertarget{data-import}{%
\section{Data import}\label{data-import}}

We will be beginning our analysis with demultiplexed, quality controlled sequences.

For the purpose of this workshop we will not use the entire dataset per sample. We have created 1000 sequences per sample as subset. This will be your input dataset.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{cd}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/QIIME2\_Analysis}

\CommentTok{\# Copy the subset file of sequences:}

\FunctionTok{cp}\NormalTok{ /home/metag/data/seqs.1000.fna ./}

\ExtensionTok{conda}\NormalTok{ deactivate}

\BuiltInTok{source}\NormalTok{ activate qiime2}

\CommentTok{\# This command will vary depending input data type and format}
\CommentTok{\# Here, we are importing .fasta reads (no quality scores)}

\ExtensionTok{qiime}\NormalTok{ tools import }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}input{-}path seqs.1000.fna }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}output{-}path seqs.1000.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}type }\StringTok{\textquotesingle{}SampleData[Sequences]\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\hypertarget{dereplicate}{%
\section{Dereplicate}\label{dereplicate}}

From \url{https://docs.qiime2.org/2021.2/tutorials/overview/\#derep-denoise}

• We dereplicate our sequences to reduce repetition and file size/memory requirements in downstream steps (Don't worry, we keep count of each replicate).

• We denoise to correct for stochastic sequencing effects and PCR error.

• We cluster sequences to collapse similar sequences (e.g., those that are ≥ 97\% similar to each other) into single replicate sequences. This process, also known as OTU picking, was once a common procedure, used to simultaneously dereplicate but also perform a quick-and-dirty denoising procedure. Use denoising methods instead if you can.

\begin{Shaded}
\begin{Highlighting}[]

\ExtensionTok{qiime}\NormalTok{ vsearch dereplicate{-}sequences }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}sequences seqs.1000.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}dereplicated{-}table table.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}dereplicated{-}sequences rep{-}seqs.qza }
\end{Highlighting}
\end{Shaded}

\hypertarget{generating-a-feature-table}{%
\section{Generating a feature table}\label{generating-a-feature-table}}

The final products of all denoising and clustering methods/workflows are a FeatureTable{[}Frequency{]} (feature table) artifact and a FeatureData{[}Sequence{]} (representative sequences) artifact. These are two of the most important artifacts in an amplicon sequencing workflow, and are used for many downstream analyses, as discussed below. Indeed, feature tables are crucial to any QIIME 2 analysis, as the central record of all observations per sample.

\includegraphics[width=1\textwidth,height=\textheight]{./QIIMEpics/derep-denoise.png}
The feature-table summarize command will give you information on how many sequences are associated with each sample and with each feature, histograms of those distributions, and some related summary statistics. The feature-table and tabulate-seqs commands will provide a mapping of feature IDs to sequences, and provide links to easily BLAST each sequence against the NCBI nt database.

\hypertarget{visualization}{%
\section{Visualization}\label{visualization}}

\begin{Shaded}
\begin{Highlighting}[]

\ExtensionTok{qiime}\NormalTok{ feature{-}table summarize }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}table table.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}visualization table.qzv}


\ExtensionTok{qiime}\NormalTok{ feature{-}table tabulate{-}seqs }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}data rep{-}seqs.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}visualization rep{-}seqs.qzv}
\end{Highlighting}
\end{Shaded}

Look at the format of a feature table from a mock dataset as well as other tutorials:
\url{https://view.qiime2.org/visualization/?type=html\&src=https\%3A\%2F\%2Fdocs.qiime2.org\%2F2020.11\%2Fdata\%2Ftutorials\%2Fmoving-pictures\%2Ftable.qzv}

\hypertarget{setting-up-a-reference}{%
\section{Setting up a reference}\label{setting-up-a-reference}}

Greengenes (16S rRNA) and Silva (16S/18S rRNA) databases have to be imported as QIIME2 artifacts before using them.

\begin{Shaded}
\begin{Highlighting}[]

\ExtensionTok{qiime}\NormalTok{ tools import }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}input{-}path /home/metag/QIIME2\_greengenes/Greengenes\_16S\_rRNA/}\DataTypeTok{\textbackslash{}}
\NormalTok{gg\_13\_8\_otus/rep\_set/99\_otus.fasta }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}output{-}path 99\_otus.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}type FeatureData[Sequence]}
\end{Highlighting}
\end{Shaded}

\hypertarget{clustering-1}{%
\section{Clustering}\label{clustering-1}}

\includegraphics[width=1\textwidth,height=\textheight]{./QIIMEpics/qiimeimage.png}
There are three types of clustering,

I. De novo Operational Taxonomic Unit (OTU) clustering

De novo OTU picking is used when we dont have a reference sequence collection to cluster against, for example, working with an infrequently used marker gene.

De novo OTU picking cannot be used in the following two scenarios,

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Comparing non-overlapping amplicons, such as V2 and V4 regions of 16S rRNA
\item
  Working with very large data sets, e.g., HiSeq
\end{enumerate}

Advantage: No reference is required.

Disadvantage: Run time can be very expensive depending on the volume of data (parallel processing not possible)

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# EXAMPLE{-} DO NOT RUN THE ABOVE COMMAND TO COMPLETION.}

\ExtensionTok{qiime}\NormalTok{ vsearch cluster{-}features{-}de{-}novo }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}table table.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}sequences rep{-}seqs.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}p{-}perc{-}identity 0.99 }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}clustered{-}table table{-}dn{-}99.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}clustered{-}sequences rep{-}seqs{-}dn{-}99.qza}
\end{Highlighting}
\end{Shaded}

\begin{enumerate}
\def\labelenumi{\Roman{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  Closed-reference OTU clustering
\end{enumerate}

Reads are clustered against a reference sequence collection. Any reads which do not hit a sequence in the reference sequence collection are excluded from downstream analyses.

Closed-reference OTU picking is used:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  When comparing non-overlapping amplicons, such as V2 and V4 regions of the 16S rRNA.
\item
  When reference sequences span the sequenced regions.
\end{enumerate}

Closed-reference OTU picking is not used when reference sequence collection is not available

Advantage: Fast, useful for extremely large data sets. Better trees and taxonomy. OTUs are defined in the reference and have a reliable tree/taxonomy.

Disadvantage: Inability to detect novel diversity with respect to your reference sequence collection

\begin{Shaded}
\begin{Highlighting}[]

\CommentTok{\# EXAMPLE{-} DO NOT RUN THE ABOVE COMMAND TO COMPLETION}

\ExtensionTok{qiime}\NormalTok{ vsearch cluster{-}features{-}closed{-}reference }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}table table.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}sequences rep{-}seqs.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}reference{-}sequences 99\_otus.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}p{-}perc{-}identity 0.99 }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}clustered{-}table table{-}cr{-}99.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}clustered{-}sequences rep{-}seqs{-}cr{-}99.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}unmatched{-}sequences unmatched{-}cr{-}99.qza}
\end{Highlighting}
\end{Shaded}

\begin{enumerate}
\def\labelenumi{\Roman{enumi}.}
\setcounter{enumi}{2}
\tightlist
\item
  Open-reference OTU clustering
\end{enumerate}

In open-reference OTU clustering, sequence reads are clustered against a reference sequence collection and any reads which do not hit the reference sequence collection are subsequently clustered de novo.

\begin{Shaded}
\begin{Highlighting}[]

\CommentTok{\# EXAMPLE{-} DO NOT RUN THE ABOVE COMMAND TO COMPLETION}

\ExtensionTok{qiime}\NormalTok{ vsearch cluster{-}features{-}open{-}reference }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}table table.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}sequences rep{-}seqs.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}reference{-}sequences 99\_otus.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}p{-}perc{-}identity 0.99 }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}clustered{-}table table{-}or{-}99.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}clustered{-}sequences rep{-}seqs{-}or{-}99.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}new{-}reference{-}sequences new{-}ref{-}seqs{-}or{-}99.qza}
\end{Highlighting}
\end{Shaded}

STEP 7: Building a phylogenetic tree

Evolution is the core concept of biology. There is only so much you can learn from microbes while ignoring evolution. Evolution-aware analyses of a dataset needs a phylogenetic tree of its sequences. These trees can be built de-novo or they can be reference based. Phylogeny-based analyses in QIIME2 generally need a rooted tree.

\begin{figure}
\centering
\includegraphics[width=1\textwidth,height=\textheight]{./QIIMEpics/forlyx.trees.qiime.png}
\caption{workflow}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]

\CommentTok{\# Carry out a multiple sequence alignment using Mafft}

\ExtensionTok{qiime}\NormalTok{ alignment mafft }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}sequences rep{-}seqs{-}or{-}99.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}alignment aligned{-}rep{-}seqs.qza}

\CommentTok{\# THE ABOVE STEP SHOULD APPROXIMATELY TAKE 4 MINUTES TO RUN TO COMPLETION}

\CommentTok{\# Mask (or filter) the alignment to remove positions that are highly variable. }
\CommentTok{\# These positions are generally considered to add noise to a}
\CommentTok{\# resulting phylogenetic tree.}

\ExtensionTok{qiime}\NormalTok{ alignment mask }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}alignment aligned{-}rep{-}seqs.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}masked{-}alignment masked{-}aligned{-}rep{-}seqs.qza}

\CommentTok{\# THE ABOVE STEP SHOULD APPROXIMATELY TAKE 4 MINUTES TO RUN TO COMPLETION}

\CommentTok{\# Create the tree using the Fasttree program}

\ExtensionTok{qiime}\NormalTok{ phylogeny fasttree }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}alignment masked{-}aligned{-}rep{-}seqs.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}tree unrooted{-}tree.qza}

\CommentTok{\# THE ABOVE STEP SHOULD APPROXIMATELY TAKE 9 MINUTES TO RUN TO COMPLETION}

\CommentTok{\# root the tree using the longest root}

\ExtensionTok{qiime}\NormalTok{ phylogeny midpoint{-}root }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}tree unrooted{-}tree.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}rooted{-}tree rooted{-}tree.qza}

\CommentTok{\# THE ABOVE STEP SHOULD APPROXIMATELY TAKE 6 SECONDS TO RUN TO COMPLETION}
\end{Highlighting}
\end{Shaded}

STEP 8: Alpha rarefaction

What is rarefaction?

Species richness is the number of species present in a system. However, the deeper you sequence, the more species you will find. That can be problematic if you gathered 500 reads from one sample and only 100 reads from another sample- you would expect to find more species if you sequenced 5x as many reads! To account for this, we perform an in-silico (i.e., on your computer) experiment called rarefaction. A rarefaction is a random collection of sequences from a sample, with a specified depth (number of sequences). For example, a rarefaction with a depth of 75 reads per sample is a simulation of what your sequencing results would look like if you sequenced exactly 75 reads from each sample. To look at alpha diversity systematically, we can perform many rarefactions: at multiple depths and repeat many times at each depth. In QIIME, this task is performed on your OTU table.

• Concerns:

-- Too low: ignore a lot of samples' information

-- Too high: ignore a lot of samples

\begin{Shaded}
\begin{Highlighting}[]

\CommentTok{\# EXAMPLE{-} DO NOT RUN THE ABOVE COMMAND TO COMPLETION}

\FunctionTok{cp}\NormalTok{ /home/elavelle/mappingFile.txt ./}

\ExtensionTok{qiime}\NormalTok{ diversity alpha{-}rarefaction }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}table table{-}or{-}99.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}phylogeny rooted{-}tree.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}p{-}max{-}depth 1000 }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}m{-}metadata{-}file mappingFile.txt }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}visualization alpha{-}rarefaction.qzv}

\CommentTok{\# Why specify a maximum depth of 1000?}
\end{Highlighting}
\end{Shaded}

Look at the following example and decide what sampling-depth you would use:

\url{https://view.qiime2.org/visualization/?type=html\&src=https\%3A\%2F\%2Fdocs.qiime2.org\%2F2020.11\%2Fdata\%2Ftutorials\%2Fmoving-pictures\%2Falpha-rarefaction.qzv}

STEP 9: Calculating and exploring diversity metrics

Species diversity is a valuable tool for describing the ecological complexity of a single sample (alpha diversity) or between samples (beta diversity).

However, diversity is not a physical quantity that can be measured directly, and many different metrics have been proposed to quantify diversity

Species diversity consists of three components: species richness, taxonomic or phylogenetic diversity and species evenness.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Species richness = the number of different species in a community.
\item
  Species evenness = how close the species abundencies in a community are.
\item
  Phylogenetic diversity = how closely related the species in a community are.
\end{enumerate}

QIIME 2 calculates comprehensive set of metrics for you with one command

Alpha diversity metrics

• Observed Features (a measure of community richness, called ``observed OTUs'' here for historical reasons)

• Evenness (or Pielou's Evenness; a measure of community evenness; Pielou, 1966)

• Shannon Diversity Index (a measure of community diversity; Shannon \& Weaver, 1949)

• Faith's Phylogenetic Diversity (a measure of diversity that incorporates phylogenetic relationships between the features; Faith, 1992); this metric is sometimes referred to as PD\_whole\_tree, but we discourage the use of that name in favor of Faith's Phylogenetic Diversity or Faith's PD

Beta diversity metrics

• Jaccard distance (qualitative comparison: \# shared OTUs / \# union OTUs *100 ; (Jaccard, 1908)

• Bray‐Curtis distance (a quantitative measure of community dissimilarity- includes abundance; Sørensen, 1948)

• unweighted UniFrac distance (a qualitative measure of community dissimilarity- analogous to Jaccard- that incorporates phylogenetic relationships between the features; Lozupone \& Knight, 2005); implementation based on Striped UniFrac (McDonald et al., 2018) method

• weighted UniFrac distance (a quantitative measure of community dissimilarity- analogous to Bray-Curtis- that incorporates phylogenetic relationships between the features; Lozupone, Hamady, Kelley, \& Knight, 2007); implementation based on Striped UniFrac (McDonald et al., 2018) method.

\begin{Shaded}
\begin{Highlighting}[]

\CommentTok{\# Generate diversity metrics}

\ExtensionTok{qiime}\NormalTok{ diversity core{-}metrics{-}phylogenetic }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}phylogeny rooted{-}tree.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}table table{-}or{-}99.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}p{-}sampling{-}depth 1000 }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}m{-}metadata{-}file mappingFile.txt }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}output{-}dir core{-}metrics{-}results}

\CommentTok{\# SEVERAL FILES WILL BE GENERATED IN A FOLDER/DIRECTORY TITLED "core{-}metrics{-}results"}
\CommentTok{\# THE ABOVE STEP SHOULD APPROXIMATELY TAKE 17 SECONDS TO RUN TO COMPLETION}

\ExtensionTok{qiime}\NormalTok{ diversity alpha{-}group{-}significance }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}alpha{-}diversity core{-}metrics{-}results/faith\_pd\_vector.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}m{-}metadata{-}file mappingFile.txt }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}visualization core{-}metrics{-}results/faith{-}pd{-}group{-}significance.qzv}

\CommentTok{\# THE ABOVE STEP SHOULD APPROXIMATELY TAKE 5 SECONDS TO RUN TO COMPLETION}

\ExtensionTok{qiime}\NormalTok{ diversity alpha{-}group{-}significance }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}alpha{-}diversity core{-}metrics{-}results/evenness\_vector.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}m{-}metadata{-}file mappingFile.txt }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}visualization core{-}metrics{-}results/evenness{-}group{-}significance.qzv}

\CommentTok{\# THE ABOVE STEP SHOULD APPROXIMATELY TAKE 5 SECONDS TO RUN TO COMPLETION}

\ExtensionTok{qiime}\NormalTok{ diversity alpha{-}group{-}significance  }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}alpha{-}diversity core{-}metrics{-}results/shannon\_vector.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}m{-}metadata{-}file mappingFile.txt }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}visualization core{-}metrics{-}results/shannon\_group{-}significance.qzv}

\CommentTok{\# THE ABOVE STEP SHOULD APPROXIMATELY TAKE 5 SECONDS TO RUN TO COMPLETION}

\ExtensionTok{qiime}\NormalTok{ diversity beta{-}group{-}significance }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}distance{-}matrix core{-}metrics{-}results/unweighted\_unifrac\_distance\_matrix.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}m{-}metadata{-}file mappingFile.txt }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}m{-}metadata{-}column BodySite }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}visualization core{-}metrics{-}results/unweighted{-}unifrac{-}body{-}site{-}significance.qzv }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}p{-}pairwise}

\CommentTok{\#THE ABOVE STEP SHOULD APPROXIMATELY TAKE 5 SECONDS TO RUN TO COMPLETION}

\ExtensionTok{qiime}\NormalTok{ diversity beta{-}group{-}significance }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}distance{-}matrix core{-}metrics{-}results/unweighted\_unifrac\_distance\_matrix.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}m{-}metadata{-}file mappingFile.txt }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}m{-}metadata{-}column Sex }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}visualization core{-}metrics{-}results/unweighted{-}unifrac{-}sex{-}significance.qzv }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}p{-}pairwise}

\CommentTok{\# THE ABOVE STEP SHOULD APPROXIMATELY TAKE 6 SECONDS TO RUN TO COMPLETION}
\end{Highlighting}
\end{Shaded}

\includegraphics[width=1\textwidth,height=\textheight]{./QIIMEpics/beta_diversity.png}
Significance for a beta diversity metric indicates lesser ingroup distances for one or more groups compared to the inter-group distances.

\hypertarget{pcoa-plot}{%
\section{PCoA plot}\label{pcoa-plot}}

Explore beta diversity metrics. Run any one metric for beta diversity, you do not have to run all the methods. Pick the one that most defines your dataset.

\begin{Shaded}
\begin{Highlighting}[]

\ExtensionTok{qiime}\NormalTok{ emperor plot }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}pcoa core{-}metrics{-}results/unweighted\_unifrac\_pcoa\_results.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}m{-}metadata{-}file mappingFile.txt }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}p{-}custom{-}axes TreatmentNumber  }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}visualization core{-}metrics{-}results/unweighted{-}unifrac{-}emperor{-}TreatmentNumber.qzv}

\CommentTok{\# THE ABOVE STEP SHOULD APPROXIMATELY TAKE 5 SECONDS TO RUN TO COMPLETION}

\ExtensionTok{qiime}\NormalTok{ emperor plot }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}pcoa core{-}metrics{-}results/bray\_curtis\_pcoa\_results.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}m{-}metadata{-}file mappingFile.txt }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}p{-}custom{-}axes TreatmentNumber }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}visualization core{-}metrics{-}results/bray{-}curtis{-}emperor{-}TreatmentNumber.qzv}

\CommentTok{\# THE ABOVE STEP SHOULD APPROXIMATELY TAKE 5 SECONDS TO RUN TO COMPLETION}

\CommentTok{\# Download the files to examine in the Qiime viewer}

\FunctionTok{scp} \AttributeTok{{-}P}\NormalTok{ 44111 }\AttributeTok{{-}r} \OperatorTok{\textless{}}\NormalTok{username}\OperatorTok{\textgreater{}}\NormalTok{@gateway.training.ncgr.org:\textasciitilde{}/QIIME2\_Analysis/core{-}metrics{-}results Desktop/}
\end{Highlighting}
\end{Shaded}

\hypertarget{assigning-taxonomy}{%
\section{Assigning taxonomy}\label{assigning-taxonomy}}

For many experiments, investigators aim to identify the organisms that are present in a sample. E.g., what genera or species are present in my samples? Are there any human pathogens in this patient's sample? We can do this by comparing our query sequences (i.e., our features, be they ASVs or OTUs) to a reference database of sequences with known taxonomic composition. Simply finding the closest alignment is not really good enough --- because other sequences that are equally close matches or nearly as close may have different taxonomic annotations. So we use taxonomy classifiers to determine the closest taxonomic affiliation with some degree of confidence or consensus (which may not be a species name if one cannot be predicted with certainty!), based on alignment, k-mer frequencies, etc.

\begin{Shaded}
\begin{Highlighting}[]

\FunctionTok{wget} \StringTok{"https://data.qiime2.org/2020.6/common/gg{-}13{-}8{-}99{-}nb{-}classifier.qza"}

\ExtensionTok{qiime}\NormalTok{ feature{-}classifier classify{-}sklearn }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}classifier gg{-}13{-}8{-}99{-}nb{-}classifier.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}reads rep{-}seqs{-}or{-}99.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}classification taxonomy.qza}

\CommentTok{\#THE ABOVE STEP SHOULD APPROXIMATELY TAKE 6 MINUTES TO RUN TO COMPLETION}

\ExtensionTok{qiime}\NormalTok{ metadata tabulate }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}m{-}input{-}file taxonomy.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}visualization taxonomy.qzv}

\CommentTok{\#THE ABOVE STEP SHOULD APPROXIMATELY TAKE 5 SECONDS TO RUN TO COMPLETION}

\ExtensionTok{qiime}\NormalTok{ taxa barplot }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}table table{-}or{-}99.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}taxonomy taxonomy.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}m{-}metadata{-}file mappingFile.txt }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}visualization taxa{-}bar{-}plots.qzv}

\CommentTok{\# THE ABOVE STEP SHOULD APPROXIMATELY TAKE 7 SECONDS TO RUN TO COMPLETION}
\end{Highlighting}
\end{Shaded}

\hypertarget{visualizing}{%
\section{Visualizing}\label{visualizing}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Copy the visualization files}

\FunctionTok{scp} \AttributeTok{{-}P}\NormalTok{ 44111 }\OperatorTok{\textless{}}\NormalTok{USERNAME}\OperatorTok{\textgreater{}}\NormalTok{@gateway.training.ncgr.org:/home/}\OperatorTok{\textless{}}\NormalTok{USERNAME}\OperatorTok{\textgreater{}}\NormalTok{/QIIME2\_1000\_Analysis}\DataTypeTok{\textbackslash{}}
\NormalTok{/core{-}metrics{-}results/}\PreprocessorTok{*}\NormalTok{.qzv ./}
\end{Highlighting}
\end{Shaded}

Open your browser and go to the following site:
\url{https://view.qiime2.org/}

STEP 12: Differential Abundance - ANCOM - Analysis of Composition of Microbes (Optional)

• Identifies taxa that are present in different abundances across sample groups

• Compares log ratio of the abundance of each taxon to the abundance of all remaining taxa one at a time

• Assumes small percentage (\textless25\%) of features are changing between groups

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Limit ANCOM analysis to samples from a single body site (as many features }
\CommentTok{\# are changing in abundance across body sites)}

\ExtensionTok{qiime}\NormalTok{ feature{-}table filter{-}samples }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}table table.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}m{-}metadata{-}file mappingFile.txt }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}p{-}where }\StringTok{"BodySite=\textquotesingle{}Nasal\textquotesingle{}"} \DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}filtered{-}table nasal{-}table.qza}

\ExtensionTok{=================================================}

\CommentTok{\# You should run the following command/plugin on your own dataset where you collapse }
\CommentTok{\# features to a chosen taxonomic level before ANCOM }
\CommentTok{\# (levels are 1{-}7, but choose something like 5 or 6)}

\ExtensionTok{qiime}\NormalTok{ taxa collapse }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}table nasal{-}table.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}taxonomy taxonomy.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}p{-}level 6 }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}collapsed{-}table nasal{-}table{-}level6.qza}

\ExtensionTok{==================================================}

\CommentTok{\# In this step, ANCOM takes logs and adds one count }
\CommentTok{\# to every value (pseudocount)}

\ExtensionTok{qiime}\NormalTok{ composition add{-}pseudocount }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}table nasal{-}table.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}composition{-}table comp{-}nasal{-}table.qza}

\CommentTok{\#run ancom }

\ExtensionTok{qiime}\NormalTok{ composition ancom }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}table comp{-}nasal{-}table.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}m{-}metadata{-}file mappingFile.txt }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}m{-}metadata{-}column Treatment }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}visualization ancom{-}Treatment{-}nasal.qzv}
\end{Highlighting}
\end{Shaded}

EXERCISE: Preparing your raw sequence data and importing -{[}\url{https://docs.qiime2.org/2020.11/tutorials/importing/\#}{]}

When using Earth Microbiome Project (EMP) protocol, you should have access to forward reads, reverse reads (if applicable),

and a barcode list, i.e.:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  forward.fastq.gz
\item
  reverse.fastq.gz
\item
  barcodes.fastq.gz
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{source}\NormalTok{ activate qiime2}

\FunctionTok{mkdir}\NormalTok{ emp\_example}

\BuiltInTok{cd}\NormalTok{ emp\_example}

\ExtensionTok{qiime}\NormalTok{ tools import }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}type EMPPairedEndSequences }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}input{-}path ./ }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}output{-}path emp{-}paired{-}end{-}sequences.qza}
\end{Highlighting}
\end{Shaded}

\hypertarget{demultiplexing}{%
\section{Demultiplexing}\label{demultiplexing}}

To demultiplex sequences we need to know which barcode sequence is associated with each sample. This information is contained in the sample metadata file.

Note: Our TB data was is already demultiplexed.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{wget}\NormalTok{ https://data.qiime2.org/2019.1/tutorials/atacama{-}soils/sample\_metadata.tsv}

\ExtensionTok{qiime}\NormalTok{ demux emp{-}paired }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}seqs emp{-}paired{-}end{-}sequences.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}m{-}barcodes{-}file sample\_metadata.tsv }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}m{-}barcodes{-}column BarcodeSequence }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}per{-}sample{-}sequences demux.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}p{-}rev{-}comp{-}mapping{-}barcodes }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}error{-}correction{-}details demux{-}details.qza}

\CommentTok{\# convert the .qza artifact to a .qzv file for visualization}

\ExtensionTok{qiime}\NormalTok{ demux summarize }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}data demux.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}visualization demux.qzv}

\CommentTok{\# scp the output file to your local machine and view in a web browser.}
\end{Highlighting}
\end{Shaded}

\hypertarget{denoising}{%
\section{Denoising}\label{denoising}}

\url{https://docs.qiime2.org/2021.2/tutorials/atacama-soils/}

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{qiime}\NormalTok{ dada2 denoise{-}paired }\DataTypeTok{\textbackslash{} }  
\ExtensionTok{{-}{-}i{-}demultiplexed{-}seqs}\NormalTok{ demux.qza }\DataTypeTok{\textbackslash{} }  
\ExtensionTok{{-}{-}p{-}trim{-}left{-}f}\NormalTok{ 13 }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}p{-}trim{-}left{-}r 13 }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}p{-}trunc{-}len{-}f 150 }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}p{-}trunc{-}len{-}r 150 }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}table table.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}representative{-}sequences rep{-}seqs.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}denoising{-}stats denoising{-}stats.qza}
\end{Highlighting}
\end{Shaded}

\hypertarget{chimeric-feature-filtering}{%
\section{Chimeric feature filtering}\label{chimeric-feature-filtering}}

\url{https://docs.qiime2.org/2021.2/tutorials/chimera/}

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{qiime}\NormalTok{ vsearch uchime{-}denovo }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}table table.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}sequences rep{-}seqs.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}output{-}dir uchime{-}dn{-}out}

\CommentTok{\# tabulate for visualization}

\ExtensionTok{qiime}\NormalTok{ metadata tabulate }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}m{-}input{-}file uchime{-}dn{-}out/stats.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}visualization uchime{-}dn{-}out/stats.qzv}

\CommentTok{\# creates filtered files}

\ExtensionTok{qiime}\NormalTok{ feature{-}table filter{-}features }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}table table.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}m{-}metadata{-}file uchime{-}dn{-}out/nonchimeras.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}filtered{-}table uchime{-}dn{-}out/table{-}nonchimeric{-}wo{-}borderline.qza }

\ExtensionTok{qiime}\NormalTok{ feature{-}table filter{-}seqs }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}data rep{-}seqs.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}m{-}metadata{-}file uchime{-}dn{-}out/nonchimeras.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}filtered{-}data uchime{-}dn{-}out/rep{-}seqs{-}nonchimeric{-}wo{-}borderline.qza }

\ExtensionTok{qiime}\NormalTok{ feature{-}table summarize }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}i{-}table uchime{-}dn{-}out/table{-}nonchimeric{-}wo{-}borderline.qza }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}o{-}visualization uchime{-}dn{-}out/table{-}nonchimeric{-}wo{-}borderline.qzv}
\end{Highlighting}
\end{Shaded}

\hypertarget{centrifuge}{%
\chapter{Centrifuge}\label{centrifuge}}

\hypertarget{what-is-centrifuge}{%
\section{What is Centrifuge?}\label{what-is-centrifuge}}

very rapid and memory-efficient system for the classification of DNA sequences from microbial
samples, with better sensitivity than and comparable accuracy to other leading systems. The system uses a
novel indexing scheme based on the Burrows-Wheeler transform (BWT) and the Ferragina-Manzini (FM) index,
optimized specifically for the metagenomic classification problem{[}1{]}.

\hypertarget{tutorial}{%
\section{Tutorial}\label{tutorial}}

For this tutorial we will use data from this publication ``Metagenomic Characterization of the Human Intestinal
Microbiota in Fecal Samples from STEC-Infected Patients'' {[}2{]}: \url{https://www.frontiersin.org/articles/10.3389/fcimb.2018.00025/}
All data used in this tutorial was retrieved from SRA with fastq-dump. SRAccession: PRJEB23207

In this study, whole genome metagenomic sequencing was used to investigate possible changes in the composition
of the intestinal microbiota in samples from patients with Shiga toxin-producing E. Coli (STEC) infection (N
= 2) compared to Crohn's Patients (N =4), healthy (N = 2) and healed controls (N = 3). Faeces samples,
collected during an outbreak, from STEC infected patients showed a lower intestinal abundance of beneficial
microorganisms in comparison to controls where those microorganisms predominated. These differences were
observed with bioinformatic approaches and seemed to be related with the STEC infection. So, using the
metagenomics data from this study can you identify the STEC positive samples? Can you identify the specific
strain of STEC?
Many of the steps have been done for you. However, I have provided instructions and code so that you can
build the full database indexes that we will use for classifying reads with Centrifuge.

\hypertarget{environment}{%
\section{Environment}\label{environment}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Remember to start a screen}
\CommentTok{\# Activate the fastqdump environment}

\BuiltInTok{source}\NormalTok{ activate fastqdump}
\end{Highlighting}
\end{Shaded}

\hypertarget{data-download-1}{%
\section{Data Download}\label{data-download-1}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Create a directory to store results}
\FunctionTok{mkdir} \AttributeTok{{-}p}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/centrifuge/fastq}
\FunctionTok{mkdir} \AttributeTok{{-}p}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/centrifuge/taxonomy}

\CommentTok{\# Copy the reads into your fastq directory}
\FunctionTok{cp}\NormalTok{ /home/elavelle/centrifuge/fastq/}\PreprocessorTok{*}\NormalTok{.fastq /home/}\VariableTok{$USER}\NormalTok{/centrifuge/fastq}

\CommentTok{\# Detach screen while this takes place}
\CommentTok{\# This is an example for downloading a single fastq file from SRA:}
\ExtensionTok{prefetch} \AttributeTok{{-}O}\NormalTok{ . }\AttributeTok{{-}p}\NormalTok{ ERR2271237}
\ExtensionTok{fastq{-}dump} \AttributeTok{{-}{-}split{-}files} \AttributeTok{{-}{-}outdir}\NormalTok{ . }\AttributeTok{{-}{-}gzip} \AttributeTok{{-}{-}skip{-}technical} \DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}readids }\AttributeTok{{-}{-}read{-}filter}\NormalTok{ pass }\AttributeTok{{-}{-}dumpbase} \AttributeTok{{-}{-}split{-}e} \AttributeTok{{-}{-}clip} \DataTypeTok{\textbackslash{}}
\NormalTok{/home/}\VariableTok{$USER}\NormalTok{/ERR2271237}
\ExtensionTok{conda}\NormalTok{ deactivate}
\CommentTok{\# Do NOT do for this tutorial.}
\CommentTok{\# Use a for loop to download many files sequentially. First, write all of the SRA accession numbers}
\CommentTok{\# that you want to download into a file, e.g., PRJEB23207\_accessions.txt}
\CommentTok{\# Use a for loop to store the SRA accession numbers from the PRJEB23207\_accessions.txt file}
\CommentTok{\# into a variable named accessions}
\VariableTok{accessions}\OperatorTok{=}\KeywordTok{\textasciigrave{}}\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ PRJEB23207\_accessions.txt}\KeywordTok{;} \ControlFlowTok{do} \FunctionTok{cat} \VariableTok{$i}\KeywordTok{;}\ControlFlowTok{done}\KeywordTok{\textasciigrave{}}
\CommentTok{\# Use a for loop to run prefetch fastq{-}dump for each SRA}
\CommentTok{\# accession number in the accessions variable}
\ControlFlowTok{for}\NormalTok{ j }\KeywordTok{in} \VariableTok{$accessions}\KeywordTok{;} \ControlFlowTok{do} \ExtensionTok{prefetch} \AttributeTok{{-}O}\NormalTok{ . }\AttributeTok{{-}p} \VariableTok{$j}\KeywordTok{;} \ControlFlowTok{done}
\ControlFlowTok{for}\NormalTok{ j }\KeywordTok{in} \VariableTok{$accessions}\KeywordTok{;} \ControlFlowTok{do} \ExtensionTok{fastq{-}dump} \AttributeTok{{-}{-}outdir}\NormalTok{ . }\AttributeTok{{-}{-}gzip} \AttributeTok{{-}{-}skip{-}technical} \DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}readids }\AttributeTok{{-}{-}read{-}filter}\NormalTok{ pass }\AttributeTok{{-}{-}dumpbase} \AttributeTok{{-}{-}split{-}e} \AttributeTok{{-}{-}clip} \DataTypeTok{\textbackslash{}}
\VariableTok{$j}\KeywordTok{;} \ControlFlowTok{done}
\end{Highlighting}
\end{Shaded}

\hypertarget{retrieve-refseq-and-eupathdb-data}{%
\section{Retrieve RefSeq and EuPathDB Data}\label{retrieve-refseq-and-eupathdb-data}}

Centrifuge provides a few scripts that will allow you to download the NCBI taxonomy tree and RefSeq reference
genomes.
• To map sequence identifiers to taxonomy IDs, and taxonomy IDs to names and their parents, three taxonomy tree files are
necessary in addition to the reference fasta files:
-- taxonomy tree files:

\begin{itemize}
\item
  nodes.dmp from the NCBI taxonomy dump. Links taxonomy IDs to their parents names.
\item
  names.dmp from the NCBI taxonomy dump. Links taxonomy IDs to their scientific name.
\item
  seqid2taxid.map is a tab-separated file that maps sequence IDs to taxonomy IDs.
\end{itemize}

• When using the provided scripts to download the genomes, these files are automatically downloaded or generated. When
using custom taxonomy or sequence files, please refer to the manual section TODO to learn more about their format. Here
is the link to the manual \url{https://ccb.jhu.edu/software/centrifuge/manual.shtml}

• command flags:
-o
specifies the folder to which the files are downloaded.
taxonomy
Argument indicates the database to download. The options are refseq, genbank, contaminants or taxonomy.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Takes \textasciitilde{}20 seconds}
\BuiltInTok{source}\NormalTok{ activate centrifuge}
\ExtensionTok{centrifuge{-}download} \AttributeTok{{-}o}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/centrifuge/taxonomy taxonomy}
\end{Highlighting}
\end{Shaded}

• Download complete fungal genomes from RefSeq with the centrifuge--download commands. Do this exercise for this tutorial
on a reduced data set.

• command flags:
-a Only download genomes with the specified assembly level. Default: 'Complete Genome'. Use 'Any' for any assembly
level.
-m Mask low-complexity regions using dustmasker. This is part of the blast program that was installed in the metagenomics
environment.
-P Number of threads or processes to use when downloading.
-d What domain to download. One or more of bacteria, viral, archaea, fungi, protozoa, invertebrate, plant, vertebrate\_
mammalian, vertebrate\_other (comma separated).
refseq Tells the program to use the refseq database.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Takes about 1 minute}
\ExtensionTok{centrifuge{-}download} \AttributeTok{{-}o}\NormalTok{ library }\AttributeTok{{-}a} \StringTok{"Complete Genome"} \AttributeTok{{-}m} \AttributeTok{{-}P}\NormalTok{ 4 }\AttributeTok{{-}d} \StringTok{"fungi"}\NormalTok{ refseq }\OperatorTok{\textgreater{}}\NormalTok{ seqid2taxid.map}
\end{Highlighting}
\end{Shaded}

• Do not do: This database was pre-built for you to use in the tutorial. Download complete archaea, bacteria, viral and fungal
genomes from RefSeq with the centrifuge--download commands. This is what you should do to build a more comprehensive
RefSeq database containing only complete genomes.
• At the time of download, there were 289 Archea, 13,287 bacterial, 8,583 viral, and 10 fungal genomes.

\begin{Shaded}
\begin{Highlighting}[]
\ExtensionTok{centrifuge{-}download} \AttributeTok{{-}o}\NormalTok{ library }\AttributeTok{{-}a} \StringTok{"Complete Genome"} \AttributeTok{{-}m} \AttributeTok{{-}P}\NormalTok{ 30 }\AttributeTok{{-}d} \StringTok{"archaea,bacteria,viral,fungi"}\NormalTok{ refseq }\DataTypeTok{\textbackslash{}}
\OperatorTok{\textgreater{}}\NormalTok{ seqid2taxid.map}
\end{Highlighting}
\end{Shaded}

• Download the RefSeq chromosome level human genome reference with centrifuge-download commands.

• Command flags are the same as the previous step:

-t Only download the specified taxonomy IDs, comma separated. Default: any. 9606 is the taxonomy id for Human.

-c Only download genomes in the specified refseq category. Default: any.

\begin{quote}
\begin{quote}
Appends the human seqid2taxid. map to the previously generated fungi seqid2taxid.map file.
\end{quote}
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Took \textasciitilde{}14 minutes during testing}
\ExtensionTok{centrifuge{-}download} \AttributeTok{{-}o}\NormalTok{ library }\AttributeTok{{-}a} \StringTok{"Chromosome"} \AttributeTok{{-}m} \AttributeTok{{-}P}\NormalTok{ 4 }\AttributeTok{{-}d} \StringTok{"vertebrate\_mammalian"} \DataTypeTok{\textbackslash{}}
\NormalTok{{-}t 9606 }\AttributeTok{{-}c} \StringTok{"reference genome"}\NormalTok{ refseq }\OperatorTok{\textgreater{}\textgreater{}}\NormalTok{ seqid2taxid.map}
\end{Highlighting}
\end{Shaded}

• *Optional. Customize your database by adding EuPathDB release 28 reference genomes. This step was done for you. The
EuPathDB data comes from this publication.
-- Here is the link to the publication \url{https://doi.org/10.1371/journal.pcbi.1006277} . Here is the webpage for the data
download \url{https://ccb.jhu.edu/data/eupathDB/}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Make new directory called eupath in the library directory. Something like this}
\FunctionTok{mkdir} \AttributeTok{{-}p}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/centrifuge/library/eupath}

\CommentTok{\# Move into the /home/$USER/centrifuge/library/eupath directory.}
\BuiltInTok{cd}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/centrifuge/library/eupath}

\CommentTok{\# This wget command will download EuPathDB data from the following link.}
\FunctionTok{wget}\NormalTok{ https://ccb.jhu.edu/data/eupathDB/dl/eupathDB.tar.gz}

\CommentTok{\# Uncompress the eupathDB.tar.gz file into the eupath directory. You should see}
\CommentTok{\# a directory named library}
\FunctionTok{tar} \AttributeTok{{-}zxvf}\NormalTok{ eupathDB.tar.gz}

\CommentTok{\# Move the fasta files from the /home/$USER/centrifuge/library/eupath/library directory}
\CommentTok{\#to /home/$USER/centrifuge/library/eupath/ directory}
\FunctionTok{mv}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/centrifuge/library/eupath/library/}\PreprocessorTok{*}\NormalTok{.fna }\DataTypeTok{\textbackslash{}}
\NormalTok{/home/}\VariableTok{$USER}\NormalTok{/centrifuge/library/eupath/}

\CommentTok{\# Extract and append the contig/scaffold and taxonomy id information from the prelim\_map.txt that was}
\CommentTok{\# downloaded with eupathDB.tar.gz file to the seqid2taxid.map file}
\FunctionTok{awk} \AttributeTok{{-}F}\StringTok{\textquotesingle{}\textbackslash{}t\textquotesingle{}} \StringTok{\textquotesingle{}\{print $2,$3\}\textquotesingle{}}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/centrifuge/library/eupath/library/}\DataTypeTok{\textbackslash{}}
\NormalTok{prelim\_map.txt }\KeywordTok{|} \FunctionTok{awk} \AttributeTok{{-}F}\StringTok{\textquotesingle{}|\textquotesingle{}} \StringTok{\textquotesingle{}\{print $1,$3\}\textquotesingle{}} \KeywordTok{|} \FunctionTok{awk} \AttributeTok{{-}F}\StringTok{\textquotesingle{} \textquotesingle{}} \StringTok{\textquotesingle{}\{print $1"\textbackslash{}t"$2\}\textquotesingle{}} \DataTypeTok{\textbackslash{}}
\OperatorTok{\textgreater{}\textgreater{}}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/centrifuge/seqid2taxid.map}
\end{Highlighting}
\end{Shaded}

• Concatenate the reference genome fasta files that were downloaded with the centrifuge-download commands. We are using
a for loop to do this; otherwise, we would have to type every file name on the command-line that we want to concatenatee.
g., cat fasta\_1.fna fasta\_2.fna \ldots. \textgreater{} \textgreater{} all\_fasta\_files.fna . For practice, we will concatenate the fungi reference genome
fasta files and the human fasta file.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/centrifuge/library/}\PreprocessorTok{*}\NormalTok{/}\PreprocessorTok{*}\NormalTok{.fna}\KeywordTok{;} \ControlFlowTok{do} \FunctionTok{cat} \VariableTok{$i} \DataTypeTok{\textbackslash{}}
\OperatorTok{\textgreater{}\textgreater{}}\NormalTok{ fungi\_Hum.fna}\KeywordTok{;}\ControlFlowTok{done}
\CommentTok{\# Centrifuge doesn\textquotesingle{}t like the header format of some sequences. Reformat the headers:}
\FunctionTok{sed} \StringTok{\textquotesingle{}s/|kraken[\^{}|]*|/ /\textquotesingle{}}\NormalTok{ fungi\_Hum.fna }\OperatorTok{\textgreater{}}\NormalTok{ fungi\_HumanFixed.fna}
\end{Highlighting}
\end{Shaded}

\hypertarget{database-building}{%
\section{Database building}\label{database-building}}

Build the Centrifuge indexes using the centrifuge-build command. This has been done for you already. It took 14
hrs and \textasciitilde{} 410 GBs of RAM using 30 threads to build this database index on logrus. And, this was just using the
``Complete Genome'' Refseq genomes for archea, bacteria, viruses, fungi, human, and EuPathDB. I attempted
to build a Centrifuge index using ``All'' RefSeq genomes for archea, bacteria, viruses, fungi, human plus the
EuPAthDB but ran out of memory on logrus. I tried re-bulding this index on a higher memory server and Centrifuge
was using 890 GBs of RAM before I killed the program. So, unless you have high-capacity compute you
may not be able to build the indexes on your system. But, the Centrifuge developers have provided various premade
indexes that you can download here, \url{ftp://ftp.ccb.jhu.edu/pub/infphilo/centrifuge/data/p+h+v.tar.gz},
with wget.

• Do this exercise for this tutorial. Build the Centrifuge database indexes with the centrifuge-build command. This is to
practice building an index.
4

• command flags:

-p The number of processes/threads to use for creating the index.

--conversion-table The seqid2taxid.map file that you created with the centrifuge-download commands.

--taxonomy-tree The nodes.dmp file that was downloaded with the first centrifuge-download command.

--name-table The nodes.dmp file that was downloaded with the first centrifuge-download command.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Each run will use about 24 GB of RAM.}
\CommentTok{\# It took 39 minutes to run during testing.}
\ExtensionTok{centrifuge{-}build} \AttributeTok{{-}p}\NormalTok{ 4 }\AttributeTok{{-}{-}conversion{-}table}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/centrifuge/seqid2taxid.map }\AttributeTok{{-}{-}taxonomy{-}tree} \DataTypeTok{\textbackslash{}}
\NormalTok{/home/}\VariableTok{$USER}\NormalTok{/centrifuge/taxonomy/nodes.dmp }\AttributeTok{{-}{-}name{-}table} \DataTypeTok{\textbackslash{}}
\NormalTok{/home/}\VariableTok{$USER}\NormalTok{/centrifuge/taxonomy/names.dmp }\DataTypeTok{\textbackslash{}}
\NormalTok{/home/}\VariableTok{$USER}\NormalTok{/centrifuge/library/fungi\_HumanFixed.fna }\DataTypeTok{\textbackslash{}}
\NormalTok{/home/}\VariableTok{$USER}\NormalTok{/centrifuge/fungi\_Human\_indeces}
\end{Highlighting}
\end{Shaded}

\hypertarget{classification}{%
\section{Classification}\label{classification}}

In this portion of the tutorial we will use the pre-built indexes that contain complete RefSeq genomes for archea,
bacteria, viruses and fungi. The human chromosome level reference genome was included and we also added
the EuPathDB database as well. Each file will use about 36 GB of RAM, so not every one can run
samples at the same time.

• Classify reads with Centrifuge.

• command flags:

-x Path to the indexes

-- Index location
/home/metag/centrifuge/complete\_genomes/Arc\_Bac\_Vir\_Hum\_Eupath\_v2

-1 Read 1 fastq file

-2 Read 2 fastq file

-t Print wall-clock time taken by search phase. This is optional.

-p Number of alignment threads to launch

--met-file Send metrics to file at

--met-stderr Send metrics to stderr

-S Output file name

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Make a directory to store your results:}
\FunctionTok{mkdir} \AttributeTok{{-}p}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/centrifuge/centrifuge\_results}
\CommentTok{\# Run Centrifuge. It will take 10 {-} 20 minutes per sample to run.}
\ExtensionTok{centrifuge} \AttributeTok{{-}x}\NormalTok{ /home/condasw/db/centrifuge/complete\_genomes/Arc\_Bac\_Vir\_Hum\_Eupath\_v2 }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}1 /home/condasw/data/Metagenomics/centrifuge/ERR2271042\_1.fastq }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}2 /home/condasw/data/Metagenomics/centrifuge/ERR2271042\_2.fastq }\AttributeTok{{-}t} \DataTypeTok{\textbackslash{}}
\NormalTok{{-}p 4 }\AttributeTok{{-}{-}met{-}file}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/centrifuge/centrifuge\_results/ERR2271042\_meta.txt }\AttributeTok{{-}{-}met{-}stderr} \DataTypeTok{\textbackslash{}}
\NormalTok{{-}S /home/}\VariableTok{$USER}\NormalTok{/centrifuge/centrifuge\_results/ERR2271042\_cent.out}

\CommentTok{\# If you have many samples to analyze, use a for loop to run centrifuge on each sample sequentially.}
\CommentTok{\# Use a for loop to store the names of the fastq files in a variable (like a list)}
\CommentTok{\# named fastq using the basename command}
\VariableTok{fastq}\OperatorTok{=}\KeywordTok{\textasciigrave{}}\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ /home/condasw/data/Metagenomics/centrifuge/}\PreprocessorTok{*}\NormalTok{\_1.fastq}\KeywordTok{;} \ControlFlowTok{do} \FunctionTok{basename} \AttributeTok{{-}s}\NormalTok{ \_1.fastq }\VariableTok{$i}\KeywordTok{;}\ControlFlowTok{done}\KeywordTok{\textasciigrave{}}
\CommentTok{\# You can view the contents of the fastq variable with the echo command}
\BuiltInTok{echo} \VariableTok{$fastq}
\CommentTok{\# Use a second for loop to read through the variable list and run centrifuge on each file in the list}
\CommentTok{\# sequentially.}
\ControlFlowTok{for}\NormalTok{ j }\KeywordTok{in} \VariableTok{$fastq}\KeywordTok{;} \ControlFlowTok{do} \ExtensionTok{centrifuge} \AttributeTok{{-}x}\NormalTok{ /home/condasw/db/centrifuge/complete\_genomes/Arc\_Bac\_Vir\_Hum\_Eupath\_v2 }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}1 /home/condasw/data/Metagenomics/centrifuge/}\VariableTok{$\{j\}}\NormalTok{\_1.fastq }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}2 /home/condasw/data/Metagenomics/centrifuge/}\VariableTok{$\{j\}}\NormalTok{\_2.fastq }\AttributeTok{{-}t} \AttributeTok{{-}p}\NormalTok{ 4 }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}met{-}file /home/}\VariableTok{$USER}\NormalTok{/centrifuge/centrifuge\_results/}\VariableTok{$\{j\}}\NormalTok{\_meta.txt }\AttributeTok{{-}{-}met{-}stderr} \DataTypeTok{\textbackslash{}}
\NormalTok{{-}S /home/}\VariableTok{$USER}\NormalTok{/centrifuge/centrifuge\_results/}\VariableTok{$\{j\}}\NormalTok{\_cent.out}\KeywordTok{;} \ControlFlowTok{done}
\end{Highlighting}
\end{Shaded}

\hypertarget{convert-output-to-kraken-style-reports}{%
\section{Convert output to Kraken-style reports}\label{convert-output-to-kraken-style-reports}}

• Create a Kraken style report from the Centrifuge output using the centrifuge-kreport command. This command used about
17 GB of memory and took about 1 minute per file to complete during testing.

• command flags:

-x Path to the indexes.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Make a directory to store your output files:}
\FunctionTok{mkdir} \AttributeTok{{-}p}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/centrifuge/centrifuge\_krn\_results}

\ExtensionTok{centrifuge{-}kreport} \AttributeTok{{-}x}\NormalTok{ /home/condasw/db/centrifuge/complete\_genomes/Arc\_Bac\_Vir\_Hum\_Eupath\_v2 }\DataTypeTok{\textbackslash{}}
\NormalTok{/home/}\VariableTok{$USER}\NormalTok{/centrifuge/centrifuge\_results/ERR2271042\_cent.out }\DataTypeTok{\textbackslash{}}
\OperatorTok{\textgreater{}}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/centrifuge/centrifuge\_krn\_results/ERR2271042\_cent.out.krn}
\end{Highlighting}
\end{Shaded}

• Use a for loop if you have many samples to analyze.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Use a for loop to store the names of the fastq files in a variable (like a list)}
\CommentTok{\# named output using the basename command}
\VariableTok{output}\OperatorTok{=}\KeywordTok{\textasciigrave{}}\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ /home/metag/centrifuge/centrifuge\_results/}\PreprocessorTok{*}\NormalTok{\_cent.out}\KeywordTok{;} \ControlFlowTok{do} \FunctionTok{basename} \AttributeTok{{-}s}\NormalTok{ \_cent.out }\VariableTok{$i}\KeywordTok{;}\ControlFlowTok{done}\KeywordTok{\textasciigrave{}}
\CommentTok{\# You can view the contents of the fastq variable with the echo command}
\BuiltInTok{echo} \VariableTok{$output}
\CommentTok{\# Use a second for loop to read through the variable list and run centrifuge on each file in the list}
\CommentTok{\# sequentially.}
\ControlFlowTok{for}\NormalTok{ j }\KeywordTok{in} \VariableTok{$output}\KeywordTok{;} \ControlFlowTok{do} \ExtensionTok{centrifuge{-}kreport} \DataTypeTok{\textbackslash{}}
\NormalTok{{-}x /home/condasw/db/centrifuge/complete\_genomes/Arc\_Bac\_Vir\_Hum\_Eupath\_v2 }\DataTypeTok{\textbackslash{}}
\NormalTok{/home/}\VariableTok{$USER}\NormalTok{/centrifuge/centrifuge\_results/}\VariableTok{$\{j\}}\NormalTok{\_cent.out }\OperatorTok{\textgreater{}} \DataTypeTok{\textbackslash{}}
\NormalTok{/home/}\VariableTok{$USER}\NormalTok{/centrifuge/centrifuge\_krn\_results/}\VariableTok{$\{j\}}\NormalTok{.krn}\KeywordTok{;} \ControlFlowTok{done}
\end{Highlighting}
\end{Shaded}

\hypertarget{parse-metadata}{%
\section{Parse Metadata}\label{parse-metadata}}

• Use awk to extract columns 2, 10, and 18 from the metadata file located at /home/metag/centrifuge/data/
PRJEB23207\_metadata.txt . Then, pipe the output to grep and exclude samples that were sequenced with the ``Ion
Torrent PGM'' platform

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Copy the /home/condasw/data/Metagenomics/centrifuge/PRJEB23207\_metadata.txt to your working directory}
\FunctionTok{cp}\NormalTok{ /home/condasw/data/Metagenomics/centrifuge/PRJEB23207\_metadata.txt }\DataTypeTok{\textbackslash{}}
\NormalTok{/home/}\VariableTok{$USER}\NormalTok{/centrifuge}
\CommentTok{\# Use awk and grep to parse the metadata file}
\CommentTok{\# {-}F is the field separator flag. In this case the metadata file is tab{-}separated \textquotesingle{}\textbackslash{}t\textquotesingle{}.}
\CommentTok{\# {-}i case{-}insensitive, {-}v exclude the search string, i.e., exclude lines that contain "ion"}
\FunctionTok{awk} \AttributeTok{{-}F}\StringTok{\textquotesingle{}\textbackslash{}t\textquotesingle{}} \StringTok{\textquotesingle{}\{print $2,$10,$18\}\textquotesingle{}}\NormalTok{ PRJEB23207\_metadata.txt }\KeywordTok{|} \FunctionTok{grep} \AttributeTok{{-}i} \AttributeTok{{-}v} \StringTok{"ion"}
\end{Highlighting}
\end{Shaded}

\hypertarget{visualize-the-kraken-reports-with-pavian}{%
\section{Visualize the Kraken Reports with Pavian}\label{visualize-the-kraken-reports-with-pavian}}

• First, download all *.krn files to your computer using secure copy (scp) with unix, linux, or MobaXterm terminals.

• This assumes that you have installed R on your computer.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Run R by opening a terminal}
\ExtensionTok{R}
\CommentTok{\# Or click on your R application from R{-}studio or R{-}console.}

\CommentTok{\# Install Pavian if you haven\textquotesingle{}t done so:}
\ControlFlowTok{if} \KeywordTok{(}\ExtensionTok{!require}\ErrorTok{(}\ExtensionTok{remotes}\KeywordTok{))} \KeywordTok{\{} \ExtensionTok{install.packages}\ErrorTok{(}\StringTok{"remotes"}\KeywordTok{)} \KeywordTok{\}}
\ExtensionTok{remotes::install\_github}\ErrorTok{(}\StringTok{"fbreitwieser/pavian"}\KeywordTok{)}

\CommentTok{\# Start Pavian in your browser from R}
\ExtensionTok{pavian::runApp}\ErrorTok{(}\VariableTok{port}\OperatorTok{=}\NormalTok{5000}\KeywordTok{)}
\end{Highlighting}
\end{Shaded}

• A web browser should pop up. If not, Pavian can be accessed by entering this url into your browser. \url{http://127.0.0.1:5000}

• Drag the .krn files to the ``Browse'' bar under the ``Upload files'' tab.

• Click on the ``Results Overview'' tab on the left side of the screen.

• Click on the ``Sample'' tab on the left side of the screen. You will notice an interactive Sankey chart that displays different
classified taxa. You can click and drag nodes to reorder the nodes if you want. You can select different samples by clicking
on the down arrow next to the ``Select sample'' header. Select sample ERR2270960 or ERR2270961 since we know that
these two samples are likely infected with STEC.

• From the ``Sample'' page, click on the ``Table'' tab. You should see an interactive, filterable and searchable table that
summarizes the results of Centrifuge. For example, type ``Escherichia coli'' into the ``Search:'' box. A histogram will appear
that displays the numbers of reads across all samples that were classified as ``Escherichia coli''. Sort the table by the most
abundant taxa by clicking on the up arrow next to ``TaxonReads''.

• Can you can you identify the strain(s) of STEC that samples ERR2270960 and ERR2270961 likely contain?

\hypertarget{references}{%
\section{References}\label{references}}

Gigliucci F, von Meijenfeldt FAB, Knijn A, Michelacci V, Scavia G, Minelli F, Dutilh BE, Ahmad HM, Raangs GC, Friedrich
AW, Rossen JWA, Morabito S. Metagenomic Characterization of the Human Intestinal Microbiota in Fecal Samples from STECInfected
Patients. Front Cell Infect Microbiol. 2018 Feb 6;8:25. doi: 10.3389/fcimb.2018.00025. eCollection 2018. PubMed
PMID: 29468143; PubMed Central PMCID: PMC5808120.

Kim D, Song L, Breitwieser FP, Salzberg SL. Centrifuge: rapid and sensitive classification of metagenomic sequences. Genome
Res. 2016 Dec;26(12):1721-1729. Epub 2016 Oct 17. PubMed PMID: 27852649; PubMed Central PMCID: PMC5131823.

Lu J, Salzberg SL. Removing contaminants from databases of draft genomes. PLoS Comput Biol. 2018 Jun 25;14(6):e1006277.
doi: 10.1371/journal.pcbi.1006277. eCollection 2018 Jun.~PubMed PMID: 29939994; PubMed Central PMCID: PMC6034898.

\hypertarget{metatranscriptomics-analysis-with-squeezemeta}{%
\chapter{Metatranscriptomics Analysis with SqueezeMeta}\label{metatranscriptomics-analysis-with-squeezemeta}}

\hypertarget{what-is-squeezemeta}{%
\section{What is SqueezeMeta?}\label{what-is-squeezemeta}}

SqueezeMeta is a fully automatic pipeline for metagenomics/metatranscriptomics. It includes multi-metagenome support that enables co-assembly of related metagenomes and retrieval of individual genomes{[}1{]}.

\hypertarget{squeezemeta-workflow}{%
\section{SqueezeMeta Workflow}\label{squeezemeta-workflow}}

\includegraphics[width=1\textwidth,height=\textheight]{./Figures/SqueezeMeta_workflow.png}
Figure 1: Workflow of the three modes of operation of SqueezeMeta: sequential, co-assembly and merged. Starting from metagenomic samples, green, blue and red arrows indicate main steps in sequential, merged and co-assembly modes. All modes create two of the three main results tables: open reading frame (ORF) and contig tables. Co-assembly and merged modes also apply binning and, therefore, they also create the bin table.

\hypertarget{tutorial-introduction}{%
\section{Tutorial Introduction}\label{tutorial-introduction}}

Over half of adults experience gingivitis, a mild yet treatable form of periodontal disease caused by the overgrowth
of oral microbes. Left untreated, gingivitis can progress to a more severe and irreversible disease, most
commonly chronic periodontitis. While periodontal diseases are associated with a shift in the oral microbiota
composition, it remains unclear how this shift impacts microbiota function early in disease progression. Metatranscriptome
sequencing analysis indicates that during the early stages of transition to gingivitis, a number of
virulence-related transcripts were significantly differentially expressed in individual and across pooled patient
samples{[}2{]}.

In this tutorial we will analyze metatranscriptomic data from this study to identify gene function that may be associated
with disease progressions. The publication for this data is located here \url{https://www.ncbi.nlm.nih.gov/pmc/articles/18.pdf}

\includegraphics[width=1\textwidth,height=\textheight]{./Figures/gingivitis.png}
Figure 2: Study design and visualization of the progression from health to periodontal disease. On the left, the covered or uncovered teeth depict the study design utilized, in which an acrylic stent (shown in blue) was worn to cover either the entire top or bottom set of teeth during brushing throughout the course of the experiment, 2 weeks. The images on the right illustrate the clinical symptoms associated with gingivitis that were scored by trained dental professionals in this study. An modified gingival index (MGI) score of 0 represents a healthy tooth with no indication of inflammation (shown by increasing redness at the gum) or plaque (tan color on tooth). Healthy periodontia progress through various degrees of gingivitis as depicted by the MGI 1, MGI 2, and MGI 3 panels and can eventually progress to the destructive gum disease, chronic periodontitis, shown on the far right.

Many of the steps have been completed beforehand. However, instructions and code are provided so that you
can build the database and format the metadata that we will use with SqueezeMeta.

\hypertarget{conda-environment}{%
\section{Conda Environment}\label{conda-environment}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Do not do for this tutorial}

\ExtensionTok{conda}\NormalTok{ create }\AttributeTok{{-}n}\NormalTok{ squeezemeta }\AttributeTok{{-}c}\NormalTok{ bioconda }\AttributeTok{{-}c}\NormalTok{ fpusan squeezemeta sra{-}tools}
\end{Highlighting}
\end{Shaded}

\hypertarget{retrieve-databases}{%
\section{Retrieve Databases}\label{retrieve-databases}}

SqueezeMeta provides a couple scripts that will allow you to download the NCBI taxonomy tree and RefSeq
reference genomes.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Make a new directory and enter it.}

\FunctionTok{mkdir}\NormalTok{ squeezemeta}
\BuiltInTok{cd}\NormalTok{ squeezemeta}

\CommentTok{\# Download from source and format the latest version of the annotation databases for use with SqueezeMeta. Do not do this step for this tutorial (It took \textasciitilde{}14 hours).}

\ExtensionTok{make\_databases.pl}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/squeezemeta/database}
\end{Highlighting}
\end{Shaded}

\hypertarget{data-download-2}{%
\section{Data Download}\label{data-download-2}}

• This was done already but we will practice downloading data from SRA. Download the metadata from SRA

• Copy the following link into a web browser \url{https://www.ncbi.nlm.nih.gov/bioproject/PRJNA387475}

• Select the RNA Seq data with the following SRA IDs and send to the Run selector.

-- SRR5787581
-- SRR5787582
-- SRR5787583
-- SRR5787584
-- SRR5787585
-- SRR5787586

• Export the metadata to your computer and copy to logrus.

\begin{Shaded}
\begin{Highlighting}[]

\CommentTok{\# Download from source and format the latest version of the annotation databases for use with SqueezeMeta. Do not do this step for this tutorial (It took \textasciitilde{}14 hours).}

\CommentTok{\# Parse the metadata to extract the SRR IDs and sample names. This will be need to create sample\_file.txt}
\FunctionTok{awk} \AttributeTok{{-}F}\StringTok{\textquotesingle{},\textquotesingle{}} \StringTok{\textquotesingle{}\{if ($0 !\textasciitilde{}"\^{}Run") print $1,$27\}\textquotesingle{}}\NormalTok{ SraRunTable.txt }\KeywordTok{|} \FunctionTok{sort} \AttributeTok{{-}t\_} \AttributeTok{{-}k2} \AttributeTok{{-}k1} \OperatorTok{\textgreater{}}\NormalTok{ sample\_groups.txt}

\CommentTok{\# Create the sample\_file.txt file from the sample\_groups.txt file}
\FunctionTok{awk} \AttributeTok{{-}F}\StringTok{\textquotesingle{} \textquotesingle{}} \StringTok{\textquotesingle{}\{print $2"\textbackslash{}t"$1"\_pass.fastq.gz""\textbackslash{}t""pair1"\}\textquotesingle{}} \DataTypeTok{\textbackslash{}}
\NormalTok{sample\_groups.txt }\OperatorTok{\textgreater{}}\NormalTok{ sample\_file.txt}

\CommentTok{\# Create a file with just the SRR accession IDs}
\FunctionTok{awk} \StringTok{\textquotesingle{}\{print $1\}\textquotesingle{}}\NormalTok{ sample\_groups.txt }\OperatorTok{\textgreater{}}\NormalTok{ sra\_ids.txt}
\end{Highlighting}
\end{Shaded}

• Use the SRA ids for this study to download the raw fastq files from SRA using perfetch and fastq-dump from sra-tools.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Make a directory to store the fastq files}
\FunctionTok{mkdir} \AttributeTok{{-}p}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/squeezemeta/fastq}

\CommentTok{\# Move into fastq directory}
\BuiltInTok{cd}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/squeezemeta/fastq}

\CommentTok{\# Download SRA data with prefetch}
\ExtensionTok{prefetch} \AttributeTok{{-}O}\NormalTok{ . }\AttributeTok{{-}p}\NormalTok{ SRR5787581}

\CommentTok{\# Convert SRA data to fastq format using fastq{-}dump from sra{-}tools}
\ExtensionTok{fastq{-}dump} \AttributeTok{{-}{-}outdir}\NormalTok{ . }\AttributeTok{{-}{-}gzip} \AttributeTok{{-}{-}skip{-}technical} \AttributeTok{{-}{-}readids} \DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}read{-}filter pass }\AttributeTok{{-}{-}dumpbase} \AttributeTok{{-}{-}split{-}e} \DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}clip /home/}\VariableTok{$USER}\NormalTok{/squeezemeta/fastq/SRR5787581}

\CommentTok{\# Use a for loop to download many fastq from SRA.}
\CommentTok{\# Create a variable called ids to store the SRA ids that contained}
\CommentTok{\# in the sra\_ids.txt file that we created previously}
\VariableTok{ids}\OperatorTok{=}\VariableTok{$(}\OperatorTok{\textless{}}\NormalTok{sra\_ids.txt}\VariableTok{)}

\CommentTok{\# Download SRA data with prefetch using a for loop}
\ControlFlowTok{for}\NormalTok{ j }\KeywordTok{in} \VariableTok{$ids}\KeywordTok{;} \ControlFlowTok{do} \ExtensionTok{prefetch} \AttributeTok{{-}O}\NormalTok{ . }\AttributeTok{{-}p} \VariableTok{$j}\KeywordTok{;} \ControlFlowTok{done}

\CommentTok{\# Convert SRA data to fastq format using a for loop}
\ControlFlowTok{for}\NormalTok{ j }\KeywordTok{in} \VariableTok{$ids}\KeywordTok{;} \ControlFlowTok{do} \ExtensionTok{fastq{-}dump} \AttributeTok{{-}{-}outdir}\NormalTok{ . }\AttributeTok{{-}{-}gzip} \AttributeTok{{-}{-}skip{-}technical} \DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}readids }\AttributeTok{{-}{-}read{-}filter}\NormalTok{ pass }\AttributeTok{{-}{-}dumpbase} \AttributeTok{{-}{-}split{-}e} \AttributeTok{{-}{-}clip} \DataTypeTok{\textbackslash{}}
\NormalTok{/home/}\VariableTok{$USER}\NormalTok{/squeezemeta/fastq/}\VariableTok{$j}\KeywordTok{;} \ControlFlowTok{done}

\CommentTok{\# Deactivate fastqdump environment}
\ExtensionTok{conda}\NormalTok{ deactivate}
\end{Highlighting}
\end{Shaded}

• Run SqueezeMeta. The top command runs SqueezeMeta using an assembly based method for metatranscriptomics. Unfortunately,
the assembly based method my not be appropriate for this dataset. After assembly, less than 50\% of the
reads aligned to the assembly. The bottom command uses the sqm\_read.pl script to perform a read based method for
metatranscriptomics and may be more suited for this dataset.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Activate squeezemeta environment}
\BuiltInTok{source}\NormalTok{ activate squeezemeta}

\CommentTok{\# Create a symbolic link to fastq files}
\BuiltInTok{cd}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/squeezemeta/fastq}
\FunctionTok{ln} \AttributeTok{{-}s}\NormalTok{ /home/condasw/data/Metagenomics/SqueezeMeta/fastq/}\PreprocessorTok{*}\NormalTok{gz ./}

\CommentTok{\# This is an assembly based method of metatranscriptomics (Finished running in \textasciitilde{}4.25 hours)}
\BuiltInTok{cd}\NormalTok{ /home/}\VariableTok{$USER}\NormalTok{/squeezemeta}
\ExtensionTok{SqueezeMeta.pl} \AttributeTok{{-}m}\NormalTok{ coassembly }\AttributeTok{{-}p}\NormalTok{ gingivitis\_assembly\_based }\AttributeTok{{-}s}\NormalTok{ sample\_file.txt }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}f /home/}\VariableTok{$USER}\NormalTok{/squeezemeta/fastq }\AttributeTok{{-}a}\NormalTok{ megahit }\AttributeTok{{-}map}\NormalTok{ minimap2{-}sr}

\CommentTok{\# This is read based method of metatranscriptomics (Finished running in \textasciitilde{}48 hours)}
\ExtensionTok{sqm\_reads.pl} \AttributeTok{{-}p}\NormalTok{ gingivitis\_read\_based }\AttributeTok{{-}s}\NormalTok{ sample\_file.txt }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}f /home/}\VariableTok{$USER}\NormalTok{/squeezemeta/fastq }\DataTypeTok{\textbackslash{}}
\NormalTok{{-}{-}memory 0.1 }\AttributeTok{{-}{-}num{-}cpu{-}threads}\NormalTok{ 12 }\AttributeTok{{-}{-}euk}

\CommentTok{\# Softlink to pre{-}run output directory}
\FunctionTok{ln} \AttributeTok{{-}s}\NormalTok{ /home/elavelle/squeezemeta/gingivitis\_2 /home/}\VariableTok{$USER}\NormalTok{/squeezemeta/}

\CommentTok{\# Launch R}
\ExtensionTok{R}
\end{Highlighting}
\end{Shaded}

\hypertarget{analysis-of-squeezemeta}{%
\section{Analysis of SqueezeMeta}\label{analysis-of-squeezemeta}}

• Load SQMtools library and analyze SqueezeMeta data.
• SQMtools manuals \url{https://github.com/jtamames/SqueezeMeta/blob/master/SQMtools_0.5.0.pdf}
• SQMtools and R tutorial \url{https://github.com/jtamames/SqueezeMeta/wiki/Using-R-to-analyze-your-SQM-results}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Load SQMtools library}
\FunctionTok{library}\NormalTok{(}\StringTok{\textquotesingle{}SQMtools\textquotesingle{}}\NormalTok{)}
\CommentTok{\# set working directory to directory containing gingivitis\_2 folder}
\CommentTok{\# replace \textless{}username\textgreater{} with your username}
\FunctionTok{setwd}\NormalTok{(}\StringTok{\textquotesingle{}/home/$USER/squeezemeta/\textquotesingle{}}\NormalTok{)}
\CommentTok{\# Load SqueezeMeta data into R}
\NormalTok{gingivitis }\OtherTok{=} \FunctionTok{loadSQM}\NormalTok{(}\StringTok{\textquotesingle{}gingivitis\_2\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics[width=1\textwidth,height=\textheight]{./Figures/R_structure.jpg}
\caption{R\_structure}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Access Matrix of genera and their abundances}
\NormalTok{genus\_tax }\OtherTok{=}\NormalTok{ gingivitis}\SpecialCharTok{$}\NormalTok{taxa}\SpecialCharTok{$}\NormalTok{genus}\SpecialCharTok{$}\NormalTok{abund}

\CommentTok{\# Look at the first 6 genera for all 6 samples}
\NormalTok{genus\_tax[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{]}

\CommentTok{\# Access Matrix of KEGG ids and their abundances}
\NormalTok{KEGG\_table }\OtherTok{=}\NormalTok{ gingivitis}\SpecialCharTok{$}\NormalTok{functions}\SpecialCharTok{$}\NormalTok{KEGG}\SpecialCharTok{$}\NormalTok{abund}

\CommentTok{\# Look at the first 6 KEGG ids for all 6 samples}
\NormalTok{KEGG\_table[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{]}

\CommentTok{\# What Genera are there?}
\CommentTok{\# Plot the top 15 (N) taxonomies at the genus level}
\CommentTok{\# Replace percent with abund to see raw abundance instead of percentages}
\CommentTok{\# Save plots to file with ggplot2}
\FunctionTok{library}\NormalTok{(}\StringTok{\textquotesingle{}ggplot2\textquotesingle{}}\NormalTok{)}
\FunctionTok{pdf}\NormalTok{(}\StringTok{\textquotesingle{}genus\_abund.pdf\textquotesingle{}}\NormalTok{, }\AttributeTok{width=}\DecValTok{10}\NormalTok{, }\AttributeTok{height=}\DecValTok{8}\NormalTok{)}
\FunctionTok{plotTaxonomy}\NormalTok{(gingivitis, }\AttributeTok{rank=}\StringTok{\textquotesingle{}genus\textquotesingle{}}\NormalTok{, }\AttributeTok{count=}\StringTok{\textquotesingle{}percent\textquotesingle{}}\NormalTok{, }\AttributeTok{N =} \DecValTok{15}\NormalTok{)}
\FunctionTok{dev.off}\NormalTok{()}

\CommentTok{\# Now, we know something about the microbial diversity in the samples,}
\CommentTok{\# but what are they doing? We should check the functional}
\CommentTok{\# profile(KEGG, COG and PFAM annotations) of the samples:}
\FunctionTok{pdf}\NormalTok{(}\StringTok{\textquotesingle{}KEGG\_tpm.pdf\textquotesingle{}}\NormalTok{, }\AttributeTok{width=}\DecValTok{14}\NormalTok{, }\AttributeTok{height=}\DecValTok{12}\NormalTok{)}
\FunctionTok{plotFunctions}\NormalTok{(gingivitis, }\AttributeTok{fun\_level =}\StringTok{"KEGG"}\NormalTok{, }\AttributeTok{count =}\StringTok{"tpm"}\NormalTok{, }\AttributeTok{N =} \DecValTok{20}\NormalTok{)}
\FunctionTok{dev.off}\NormalTok{()}

\CommentTok{\# Which functions are more abundant in the project? We use the DESeq2 package to}
\CommentTok{\# analyze which functions are significantly more abundant in}
\CommentTok{\# Load DESeq2 package}
\FunctionTok{library}\NormalTok{(}\StringTok{\textquotesingle{}DESeq2\textquotesingle{}}\NormalTok{)}

\CommentTok{\# Create the required matrix with the raw abundances, colData (metadata file)}
\NormalTok{metadata }\OtherTok{=} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\StringTok{\textquotesingle{}MGI0\textquotesingle{}}\NormalTok{,}\DecValTok{3}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\StringTok{\textquotesingle{}MGI2\textquotesingle{}}\NormalTok{,}\DecValTok{3}\NormalTok{)))}
\FunctionTok{rownames}\NormalTok{(metadata) }\OtherTok{=} \FunctionTok{colnames}\NormalTok{(gingivitis}\SpecialCharTok{$}\NormalTok{functions}\SpecialCharTok{$}\NormalTok{KEGG}\SpecialCharTok{$}\NormalTok{abund)}
\FunctionTok{colnames}\NormalTok{(metadata)}\OtherTok{=}\StringTok{\textquotesingle{}condition\textquotesingle{}}

\CommentTok{\# Verify sample order}
\FunctionTok{all}\NormalTok{(}\FunctionTok{rownames}\NormalTok{(metadata)}\SpecialCharTok{==}\FunctionTok{colnames}\NormalTok{(gingivitis}\SpecialCharTok{$}\NormalTok{functions}\SpecialCharTok{$}\NormalTok{KEGG}\SpecialCharTok{$}\NormalTok{abund))}

\CommentTok{\# Convert your data to the format required by DESeq2}
\NormalTok{dds }\OtherTok{=} \FunctionTok{DESeqDataSetFromMatrix}\NormalTok{(}\AttributeTok{countData =}\NormalTok{ gingivitis}\SpecialCharTok{$}\NormalTok{functions}\SpecialCharTok{$}\NormalTok{KEGG}\SpecialCharTok{$}\NormalTok{abund, }\AttributeTok{colData =}\NormalTok{ metadata,}
\AttributeTok{design =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ condition)}

\CommentTok{\# Remove low abundant KEGGs:}
\NormalTok{keep }\OtherTok{=} \FunctionTok{rowSums}\NormalTok{(}\FunctionTok{counts}\NormalTok{(dds)) }\SpecialCharTok{\textgreater{}=} \DecValTok{10}
\NormalTok{dds }\OtherTok{=}\NormalTok{ dds[keep,]}

\CommentTok{\# Choose factor levels}
\NormalTok{dds}\SpecialCharTok{$}\NormalTok{condition}\OtherTok{=}\FunctionTok{factor}\NormalTok{(dds}\SpecialCharTok{$}\NormalTok{condition, }\AttributeTok{levels=}\FunctionTok{c}\NormalTok{(}\StringTok{\textquotesingle{}MGI2\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}MGI0\textquotesingle{}}\NormalTok{))}

\CommentTok{\# Run DESeq2}
\NormalTok{dds2}\OtherTok{=}\FunctionTok{DESeq}\NormalTok{(dds)}
\NormalTok{results}\OtherTok{=}\FunctionTok{results}\NormalTok{(dds2, }\AttributeTok{name=}\StringTok{\textquotesingle{}condition\_MGI0\_vs\_MGI2\textquotesingle{}}\NormalTok{)}

\CommentTok{\# Make and save MA plot}
\DecValTok{6}
\FunctionTok{pdf}\NormalTok{(}\StringTok{"MA\_plot.pdf"}\NormalTok{)}
\FunctionTok{plotMA}\NormalTok{(results, }\AttributeTok{ylim=}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{))}
\FunctionTok{dev.off}\NormalTok{()}

\CommentTok{\# Transform data}
\NormalTok{rld }\OtherTok{\textless{}{-}} \FunctionTok{rlogTransformation}\NormalTok{(dds2)}

\CommentTok{\# Create Heatmap based on KEGG expression}
\NormalTok{sampleDists }\OtherTok{\textless{}{-}} \FunctionTok{as.matrix}\NormalTok{(}\FunctionTok{dist}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{assay}\NormalTok{(rld))))}
\FunctionTok{library}\NormalTok{(gplots)}
\FunctionTok{pdf}\NormalTok{(}\StringTok{"KEGG{-}heatmap{-}samples.pdf"}\NormalTok{, }\AttributeTok{w=}\DecValTok{50}\NormalTok{, }\AttributeTok{h=}\DecValTok{50}\NormalTok{, }\AttributeTok{pointsize=}\DecValTok{50}\NormalTok{)}
\FunctionTok{heatmap.2}\NormalTok{(}\FunctionTok{as.matrix}\NormalTok{(sampleDists), }\AttributeTok{key=}\NormalTok{F, }\AttributeTok{trace=}\StringTok{"none"}\NormalTok{,}
\AttributeTok{col=}\FunctionTok{colorpanel}\NormalTok{(}\DecValTok{100}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"white"}\NormalTok{),}
\AttributeTok{margin=}\FunctionTok{c}\NormalTok{(}\DecValTok{30}\NormalTok{, }\DecValTok{30}\NormalTok{), }\AttributeTok{main=}\StringTok{"Sample Distance Matrix"}\NormalTok{)}
\FunctionTok{dev.off}\NormalTok{()}

\CommentTok{\# Principal components analysis}
\CommentTok{\# Can do with built{-}in DESeq2 function:}
\FunctionTok{pdf}\NormalTok{(}\StringTok{"KEGG\_pca.pdf"}\NormalTok{)}
\FunctionTok{plotPCA}\NormalTok{(rld, }\AttributeTok{intgroup=}\FunctionTok{c}\NormalTok{(}\StringTok{"condition"}\NormalTok{))}
\FunctionTok{dev.off}\NormalTok{()}

\CommentTok{\# Get differential expression results for MGI0 vs MGI2}
\NormalTok{MGI2\_from\_MGI0 }\OtherTok{\textless{}{-}} \FunctionTok{results}\NormalTok{(dds2, }\AttributeTok{contrast=}\FunctionTok{c}\NormalTok{(}\StringTok{"condition"}\NormalTok{, }\StringTok{"MGI0"}\NormalTok{, }\StringTok{"MGI2"}\NormalTok{))}

\CommentTok{\# Order by adjusted p{-}value}
\NormalTok{MGI2\_from\_MGI0 }\OtherTok{\textless{}{-}}\NormalTok{ MGI2\_from\_MGI0[}\FunctionTok{order}\NormalTok{(MGI2\_from\_MGI0}\SpecialCharTok{$}\NormalTok{padj), ]}

\CommentTok{\# Merge with normalized count data}
\NormalTok{resdata }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(}\FunctionTok{as.data.frame}\NormalTok{(MGI2\_from\_MGI0), }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{counts}\NormalTok{(dds2, }\AttributeTok{normalized=}\ConstantTok{TRUE}\NormalTok{)),}
\AttributeTok{by=}\StringTok{"row.names"}\NormalTok{, }\AttributeTok{sort=}\ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{names}\NormalTok{(resdata)[}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \StringTok{"KEGG"}
\FunctionTok{head}\NormalTok{(resdata, }\AttributeTok{n =} \DecValTok{15}\NormalTok{)}

\CommentTok{\# Write results}
\FunctionTok{write.csv}\NormalTok{(resdata, }\AttributeTok{file=}\StringTok{"MGI2\_from\_MGI0\_DE.csv"}\NormalTok{)}

\CommentTok{\# Now we can subset the SqueezeMeta results and create heatmaps for the most significant KEGGs}
\NormalTok{top15\_sigs }\OtherTok{=} \FunctionTok{subsetFun}\NormalTok{(gingivitis, }\AttributeTok{fun =} \StringTok{\textquotesingle{}K09942|K01775|K11607|K15022|K02647|K05524|K00176|K01267| \textbackslash{}}
\StringTok{|K03469|K07095|K08987|K11604|K17472|K11645|K16950\textquotesingle{}}\NormalTok{, }\AttributeTok{fixed =}\NormalTok{ F)}
\FunctionTok{pdf}\NormalTok{(}\StringTok{"top\_15\_sig.pdf"}\NormalTok{)}
\FunctionTok{plotFunctions}\NormalTok{(top15\_sigs, }\AttributeTok{fun\_level =} \StringTok{"KEGG"}\NormalTok{, }\AttributeTok{count =} \StringTok{\textquotesingle{}tpm\textquotesingle{}}\NormalTok{)}
\FunctionTok{dev.off}\NormalTok{()}

\CommentTok{\# Now subset data for all significant pathways with padj \textless{}= 0.05}
\CommentTok{\# First we will look at the DE results spreadsheet MGI0\_VS\_MGI2\_DE.CSV and select KEGGs with padj}
\NormalTok{all\_sigs }\OtherTok{=} \FunctionTok{subsetFun}\NormalTok{(gingivitis, }\AttributeTok{fun =} \StringTok{\textquotesingle{}K09942|K01775|K11607|K15022|K02647|K05524|K00176|K01267|\textbackslash{}}
\StringTok{|K03469|K07095|K08987|K11604|K17472|K11645|K16950|K16191|K06889|K15539|K19002|K00876|K02119|\textbackslash{}}
\StringTok{|K02120|K16327|K06079|K08999|K04758|K11066|K08279|K09946|K02392|K11910|K03409|K07658|K01761|\textbackslash{}}
\StringTok{|K02794|K01364|K01923|K00278|K01284|K01489|K09797|K21556|K15582|K12410|K13789|K14982|K15125|\textbackslash{}}
\StringTok{|K06298|K03856|K00266|K03551|K09607|K04026|K03558|K20777|K02389|K01443|K03152|K11748|K02388|\textbackslash{}}
\StringTok{|K03426|K03584|K05515|K12527|K00226|K01783|K07444|K11995|K11720|K11617|K01006|K02039|K16066|\textbackslash{}}
\StringTok{|K00552|K16149|K03555|K17722|K01486|K07775|K07305|K03413|K03548|K09762|K03324|K07636|K00830|\textbackslash{}}
\StringTok{|K02666|K03273|K02970|K03817|K12994|K12264|K07106|K22431|K00412|K06948|K00812|K01961|K07729|\textbackslash{}}
\StringTok{|K00978|K03332|K03151|K06861|K13098|K02406|K06890|K01791|K13888|K00848|K02919|K00030|K01919|\textbackslash{}}
\StringTok{|K02409|K22212|K22432|K02656|K08364|K01182|K09775|K15789|K18987|K22293|K07346|K11708|K00265|\textbackslash{}}
\StringTok{|K05807|K04756|K03655|K03648|K01807|K16511|K00337|K13677|K00549|K02837|K02784|K07035|K07078|\textbackslash{}}
\StringTok{|K07258|K02824|K02556|K01627|K06188|K02836|K03831|K10119|K09474|K02518|K03292|K03308|K00826|\textbackslash{}}
\StringTok{|K06209|K02897|K02668|K21472|K12132|K06485|K07665|K03594|K00013|K03191|K01950|K01739|K01926|\textbackslash{}}
\StringTok{|K03718|K07343|K02395|K19286|K19354|K03205|K00570|K07137|K02393|K03585|K16301|K03589|K01887|\textbackslash{}}
\StringTok{|K03569|K00788|K05837|K19157|K02124|K02217|K07473|K06020|K16012|K02952|K03270|K03694|K20884|\textbackslash{}}
\StringTok{|K19304|K00748|K06178|K03828|K07791|K01092|K01609|K00794|K01507|K02028|K03086|K07037|K03339|\textbackslash{}}
\StringTok{|K06950|K07031|K09153|K13012|K00558|K02431|K03595|K02340|K08218|K07098|K01819|K18133|K06131|\textbackslash{}}
\StringTok{|K07216|K07273|K01420|K07816|K00602|K00158|K19158|K01924|K04082|K05601|K11145|K02123|K02529|\textbackslash{}}
\StringTok{|K01095|K11068|K06871|K02025|K02117|K11473|K03969|K14059|K01243|K01358|K20114|K07016|K09794|\textbackslash{}}
\StringTok{|K12960|K03289|K01653|K03790|K04764|K03841|K03089|K10530|K02563|K01754|K02343|K02110|K09791|\textbackslash{}}
\StringTok{|K06042|K03110|K13634|K01858|K04486|K00101|K01682|K03601\textquotesingle{}}\NormalTok{, }\AttributeTok{fixed =}\NormalTok{ F)}

\CommentTok{\# To calculate the log{-}fold change of a KEGG, you can provide a list of vectors.}
\CommentTok{\# Create vectors with sample names by condition (cond):}
\NormalTok{MGI0.samples }\OtherTok{=}\NormalTok{ gingivitis}\SpecialCharTok{$}\NormalTok{misc}\SpecialCharTok{$}\NormalTok{samples[}\FunctionTok{grep}\NormalTok{(}\StringTok{\textquotesingle{}MGI0\textquotesingle{}}\NormalTok{, gingivitis}\SpecialCharTok{$}\NormalTok{misc}\SpecialCharTok{$}\NormalTok{samples)]}
\DecValTok{7}
\NormalTok{MGI2.samples }\OtherTok{=}\NormalTok{ gingivitis}\SpecialCharTok{$}\NormalTok{misc}\SpecialCharTok{$}\NormalTok{samples[}\FunctionTok{grep}\NormalTok{(}\StringTok{\textquotesingle{}MGI2\textquotesingle{}}\NormalTok{, gingivitis}\SpecialCharTok{$}\NormalTok{misc}\SpecialCharTok{$}\NormalTok{samples)]}
\NormalTok{cond }\OtherTok{=} \FunctionTok{list}\NormalTok{(MGI0.samples, MGI2.samples)}

\CommentTok{\# Choose colors, one per condition}
\NormalTok{colors }\OtherTok{=} \FunctionTok{c}\NormalTok{(}\StringTok{\textquotesingle{}\#006682\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}\#c26e00\textquotesingle{}}\NormalTok{) }\DocumentationTok{\#\#006682 = blue , \#c26e00 = orange}

\CommentTok{\# Plot log2 fold changes using copy number abundances in the selected KEGG pathway:}
\CommentTok{\# beta{-}Lactam resistance Ko01501}
\CommentTok{\# The hue of the color depends on the value of the log{-}fold{-}change calculated using}
\CommentTok{\# copy numbers: the darkest orange implies a log{-}fold{-}change value \textgreater{}= 1.5}
\CommentTok{\#(more abundant in MGI2) and the darkest blue a log{-}fold{-}change \textless{}= {-}1.5}
\CommentTok{\#(more abundant in MGI0 samples). See Figure 3 below:}
\FunctionTok{exportPathway}\NormalTok{(all\_sigs, }\StringTok{\textquotesingle{}01501\textquotesingle{}}\NormalTok{, }\AttributeTok{output\_suffix =} \StringTok{\textquotesingle{}beta\_lactam\_resis.log2FC\textquotesingle{}}\NormalTok{,}
\AttributeTok{fold\_change\_colors =}\NormalTok{ colors, }\AttributeTok{fold\_change\_groups =}\NormalTok{ cond, }\AttributeTok{count =}\StringTok{\textquotesingle{}copy\_number\textquotesingle{}}\NormalTok{,}
\AttributeTok{max\_scale\_value =} \DecValTok{10}\NormalTok{)}

\CommentTok{\# Periodontal Pathogens Produce Quorum Sensing Signal Molecules}
\FunctionTok{exportPathway}\NormalTok{(all\_sigs, }\StringTok{\textquotesingle{}02024\textquotesingle{}}\NormalTok{, }\AttributeTok{output\_suffix =} \StringTok{\textquotesingle{}Quorum\_sensing.log2FC\textquotesingle{}}\NormalTok{,}
\AttributeTok{fold\_change\_colors =}\NormalTok{ colors, }\AttributeTok{fold\_change\_groups =}\NormalTok{ cond, }\AttributeTok{count =}\StringTok{\textquotesingle{}copy\_number\textquotesingle{}}\NormalTok{,}
\AttributeTok{max\_scale\_value =} \DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{references-1}{%
\section{References}\label{references-1}}

{[}1{]} Tamames J, Puente-Sánchez F. SqueezeMeta, A Highly Portable, Fully Automatic Metagenomic Analysis Pipeline. Front
Microbiol. 2019;9:3349. Published 2019 Jan 24. \url{doi:10.3389/fmicb.2018.03349}

{[}2{]} Microbiota and Metatranscriptome Changes Accompanying the Onset of Gingivitis Emily M. Nowicki, Raghav Shroff, Jacqueline
A. Singleton, Diane E. Renaud, Debra Wallace, Julie Drury, Jolene Zirnheld, Brock Colleti, Andrew D. Ellington,
Richard J. Lamont, David A. Scott, Marvin Whiteley mBio. 2018 Mar-Apr; 9(2): e00575-18. Published online 2018 Apr 17.
doi: 10.1128/mBio.00575-18 PMCID: PMC5904416.

  \bibliography{book.bib,packages.bib}

\end{document}
